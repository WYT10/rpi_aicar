<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>AI Car Studio</title>
  <style>
    :root {
      --bg: #050509;
      --card: #141420;
      --card-border: #2b2b3a;
      --accent: #4f7dff;
      --accent-soft: rgba(79, 125, 255, 0.15);
      --accent-2: #ff6fb1;
      --text-main: #f5f5ff;
      --text-soft: #9ca3c7;
      --pill-bg: rgba(255, 255, 255, 0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      padding: 16px;
      margin: 0;
      min-height: 100vh;
      color: var(--text-main);
      background:
        radial-gradient(circle at top left, #26245f 0, transparent 55%),
        radial-gradient(circle at bottom right, #43185c 0, transparent 55%),
        var(--bg);
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 24px;
      letter-spacing: 0.03em;
    }

    h2 {
      margin-top: 0;
      font-size: 18px;
    }

    p {
      color: var(--text-soft);
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.3);
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
    }

    .tab-btn {
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-soft);
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s all ease;
    }

    .tab-btn::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: transparent;
    }

    .tab-btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--text-main);
    }

    .tab-btn.active::before {
      background: var(--accent);
    }

    .tab-content {
      display: none;
      border-radius: 16px;
      padding: 14px 14px 18px 14px;
      background:
        linear-gradient(135deg, rgba(255, 255, 255, 0.04), transparent),
        var(--card);
      border: 1px solid var(--card-border);
      box-shadow:
        0 20px 40px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.02);
      margin-bottom: 12px;
    }

    .tab-content.active {
      display: block;
    }

    button {
      margin: 3px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-main);
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s all ease;
    }

    button:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.18);
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-color: transparent;
      color: #fff;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.03), 0 12px 24px rgba(0, 0, 0, 0.7);
    }

    button.primary:hover {
      filter: brightness(1.08);
    }

    input[type="number"],
    input[type="text"],
    select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(8, 8, 20, 0.8);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      min-width: 60px;
    }

    input[type="text"] {
      width: 160px;
    }

    input[type="checkbox"] {
      margin-right: 4px;
    }

    select {
      min-width: 120px;
    }

    label {
      font-size: 13px;
      color: var(--text-soft);
    }

    #video {
      border-radius: 12px;
      background: #000;
      max-width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.8);
      cursor: crosshair;
    }

    pre,
    textarea {
      width: 100%;
      box-sizing: border-box;
      background: #050510;
      color: var(--text-main);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 8px;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    textarea {
      min-height: 200px;
      resize: vertical;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .fs-list {
      max-height: 260px;
      overflow-y: auto;
      border-radius: 10px;
      padding: 4px;
      background: #05050c;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .fs-entry {
      display: flex;
      justify-content: space-between;
      padding: 3px 6px;
      cursor: pointer;
      font-size: 13px;
      border-radius: 6px;
      color: var(--text-soft);
    }

    .fs-entry:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-main);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      font-size: 11px;
      background: var(--pill-bg);
      color: var(--text-soft);
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #9ca3ff;
    }

    .pill-ok .pill-dot {
      background: #4ade80;
    }

    .pill-bad .pill-dot {
      background: #f97373;
    }

    .left-col,
    .right-col {
      flex: 1 1 0;
      min-width: 0;
    }

    .split {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }

    hr.soft {
      border: none;
      border-top: 1px dashed rgba(255, 255, 255, 0.12);
      margin: 10px 0;
    }

    /* Joystick */
    #joystick-wrapper {
      margin-top: 4px;
    }

    #joystick-base {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      position: relative;
      background:
        radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.2), transparent 60%),
        radial-gradient(circle at 70% 70%, rgba(0, 0, 0, 0.9), #05050c);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(0, 0, 0, 0.8);
      touch-action: none;
      cursor: grab;
    }

    #joystick-base::before {
      content: "";
      position: absolute;
      inset: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 70%;
      border-radius: 50%;
      border: 1px dashed rgba(255, 255, 255, 0.12);
    }

    #joystick-handle {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background:
        radial-gradient(circle at 30% 20%, #ffffff, #ccccff 30%, #4f7dff 70%);
      box-shadow:
        0 10px 20px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.7);
      pointer-events: none;
    }

    .joystick-caption {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
      max-width: 220px;
    }

    @media (max-width: 900px) {
      .split {
        flex-direction: column;
      }
    }

    #click-marker {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid #ff6fb1;
      background: rgba(255, 111, 177, 0.3);
      transform: translate(-50%, -50%);
      pointer-events: none;
      display: none;
    }
  </style>
</head>

<body>
  <div class="app-header">
    <div>
      <h1>AI Car Studio</h1>
      <p style="margin:0;font-size:13px;color:var(--text-soft);">
        Mini AI car playground ‚Äì camera, data, training, deploy ‚Äì all from the browser.
      </p>
    </div>
    <div>
      <span class="badge">Raspberry Pi ‚Ä¢ v2 UI</span>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="file">File</button>
    <button class="tab-btn" data-tab="image">Image</button>
    <button class="tab-btn" data-tab="train">Train</button>
    <button class="tab-btn" data-tab="deploy">Deploy</button>
  </div>

  <!-- FILE TAB -->
  <div id="tab-file" class="tab-content active">
    <div class="split">
      <div class="left-col">
        <h2>File Manager</h2>
        <div class="row">
          <label>Path:
            <input id="fs-path" type="text" value=".">
          </label>
          <button onclick="fsList()">List</button>
        </div>
        <div class="row">
          <button onclick="fsNewFile()">New File</button>
          <button onclick="fsNewDir()">New Folder</button>
          <button onclick="fsDelete()">Delete Selected</button>
        </div>
        <div class="row">
          <span id="fs-selected" class="pill">
            <span class="pill-dot"></span> selected: none
          </span>
        </div>
        <div class="fs-list" id="fs-list"></div>
      </div>
      <div class="right-col">
        <h2>Editor</h2>
        <div class="row">
          <span id="fs-edit-path" class="pill">
            <span class="pill-dot"></span> no file
          </span>
          <button class="primary" onclick="fsSave()">Save</button>
        </div>
        <textarea id="fs-editor" placeholder="Open a file from the list to edit it here"></textarea>
      </div>
    </div>
  </div>

  <!-- IMAGE TAB -->
  <div id="tab-image" class="tab-content">
    <h2>Image & Data</h2>

    <div class="split">
      <div class="left-col">
        <h3>Camera</h3>
        <div class="row">
          <button class="primary" onclick="startCamera()">Start Camera</button>
          <button onclick="stopCamera()">Stop</button>
          <button onclick="snapshot()">Snapshot</button>
          <span id="cam-status" class="pill">
            <span class="pill-dot pill-bad"></span> Camera: unknown
          </span>
        </div>
        <div class="row">
          <label><input id="vflip" type="checkbox" onchange="updateProc()">V Flip</label>
          <label><input id="hflip" type="checkbox" onchange="updateProc()">H Flip</label>
          <label><input id="gray" type="checkbox" onchange="updateProc()">Gray</label>

          <label>Mode:
            <select id="proc-mode" onchange="updateProc()">
              <option value="raw">raw</option>
              <option value="gray">gray</option>
              <option value="edges">edges</option>
            </select>
          </label>

          <label>Gamma:
            <input id="gamma" type="number" step="0.1" value="1.0" min="0.5" max="2.0" onchange="updateProc()">
          </label>
        </div>

        <div style="position:relative; display:inline-block;">
          <img id="video" src="" alt="Camera stream (click to label)">
          <div id="click-marker"></div>
        </div>

        <p style="font-size:12px;margin-top:6px;">
          Click on the image to save a labeled frame (x,y) into the current dataset.
          <br>
          <span id="last-label" class="pill">
            <span class="pill-dot"></span> last label: none
          </span>
        </p>
      </div>

      <div class="right-col">
        <h3>Datasets & Manual Control</h3>
        <div class="row">
          <label>Dataset:
            <select id="dataset-select"></select>
          </label>
          <button onclick="refreshDatasets()">Refresh</button>
        </div>
        <div class="row">
          <input id="dataset-new" type="text" placeholder="new dataset name">
          <button onclick="createDataset()">Create/Select</button>
          <span id="dataset-current" class="pill">
            <span class="pill-dot"></span> current: ?
          </span>
        </div>

        <pre id="dataset-summary" style="margin-top:6px;font-size:11px;max-height:120px;overflow:auto;"></pre>

        <hr class="soft">

        <h4>Joystick Drive</h4>
        <div class="row">
          <div id="joystick-wrapper">
            <div id="joystick-base">
              <div id="joystick-handle"></div>
            </div>
            <div class="joystick-caption">
              Drag inside the circle to drive.
              <br>Up/down = forward/back, left/right = turn.
            </div>
          </div>
          <div>
            <div class="row">
              <label>Left:
                <input id="left" type="number" step="0.1" value="0.0" min="-1" max="1">
              </label>
            </div>
            <div class="row">
              <label>Right:
                <input id="right" type="number" step="0.1" value="0.0" min="-1" max="1">
              </label>
            </div>

            <div class="row">
              <label>Speed gain:
                <input id="joy-speed" type="number" step="0.1" value="0.6" min="0" max="1">
              </label>
              <label>Steering gain:
                <input id="joy-steer" type="number" step="0.1" value="0.7" min="0" max="1">
              </label>
            </div>

            <div class="row">
              <button onclick="sendMotors()">Apply (direct)</button>
              <button onclick="stopMotors()">Stop</button>
            </div>
          </div>
        </div>

        <hr class="soft">

        <h4>Logging</h4>
        <div class="row">
          <label>Log rate (Hz):
            <input id="log-rate" type="number" step="0.5" value="5">
          </label>
          <label>Tag:
            <input id="log-tag" type="text" value="auto">
          </label>
        </div>
        <div class="row">
          <button onclick="startLogging()">Start Logging</button>
          <button onclick="stopLogging()">Stop Logging</button>
          <span id="log-status" class="pill">
            <span class="pill-dot"></span> logging: off
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- TRAIN TAB -->
  <div id="tab-train" class="tab-content">
    <h2>Train</h2>
    <p style="font-size:13px;">
      Currently this is a stub trainer that simulates training. Later we plug in your tiny CNN for (x,y) regression.
    </p>
    <div class="row">
      <label>Dataset:
        <select id="train-dataset"></select>
      </label>
      <button onclick="refreshTrainDatasets()">Refresh</button>
    </div>
    <div class="row">
      <label>Epochs:
        <input id="train-epochs" type="number" value="10" min="1">
      </label>
      <label>Learning rate:
        <input id="train-lr" type="text" value="0.001">
      </label>
      <label>Batch size:
        <input id="train-batch" type="number" value="32" min="1">
      </label>
      <button class="primary" onclick="startTrain()">Start Training</button>
    </div>
    <pre id="train-status"></pre>
    <pre id="train-dataset-summary" style="margin-top:6px;font-size:11px;max-height:120px;overflow:auto;"></pre>
  </div>

  <!-- DEPLOY TAB -->
  <div id="tab-deploy" class="tab-content">
    <h2>Deploy (Stub Autopilot)</h2>
    <div class="row">
      <button class="primary" onclick="startAutopilot()">Start Autopilot</button>
      <button onclick="stopAutopilot()">Stop</button>
      <button onclick="pollDeployStatus()">Refresh Status</button>
    </div>

    <div class="row">
      <label>Throttle gain:
        <input id="deploy-throttle" type="number" step="0.1" value="1.0">
      </label>
      <label>Steering gain:
        <input id="deploy-steering" type="number" step="0.1" value="1.0">
      </label>
      <label>Expo:
        <input id="deploy-expo" type="number" step="0.1" value="1.0">
      </label>
      <label>
        <input id="deploy-drive" type="checkbox"> Drive motors
      </label>
      <button onclick="updateDeployGains()">Apply</button>
    </div>

    <pre id="deploy-status"></pre>
  </div>

  <script>
    // ---------- Tabs ----------
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabContents = document.querySelectorAll(".tab-content");

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.toggle("active", b === btn));
        tabContents.forEach(c => c.classList.toggle("active", c.id === "tab-" + tab));
      });
    });

    // ---------- File tab ----------
    let fsSelectedPath = null;

    async function fsList() {
      const path = document.getElementById("fs-path").value;
      const res = await fetch("/api/fs/list?path=" + encodeURIComponent(path));
      const data = await res.json();
      const list = document.getElementById("fs-list");
      list.innerHTML = "";
      if (!data.ok) {
        list.textContent = "Error: " + data.error;
        return;
      }
      const entries = data.data.entries || [];
      entries.forEach(e => {
        const div = document.createElement("div");
        div.className = "fs-entry";
        div.onclick = () => fsSelect(path, e);
        const left = document.createElement("span");
        left.textContent = (e.is_dir ? "üìÅ " : "üìÑ ") + e.name;
        const right = document.createElement("span");
        right.textContent = e.size != null ? e.size + " B" : "";
        div.appendChild(left);
        div.appendChild(right);
        list.appendChild(div);
      });
    }

    function fsSelect(curPath, entry) {
      let full = curPath;
      if (full === ".") full = "";
      const rel = (full ? full + "/" : "") + entry.name;
      fsSelectedPath = rel;
      document.getElementById("fs-selected").innerHTML =
        '<span class="pill-dot pill-ok"></span> selected: ' + rel;
      if (!entry.is_dir) {
        fsOpen(rel);
      }
    }

    async function fsOpen(path) {
      const res = await fetch("/api/fs/read?path=" + encodeURIComponent(path));
      const data = await res.json();
      if (!data.ok) {
        alert("Read error: " + data.error);
        return;
      }
      document.getElementById("fs-edit-path").innerHTML =
        '<span class="pill-dot pill-ok"></span> ' + data.data.path;
      document.getElementById("fs-editor").value = data.data.content;
    }

    async function fsSave() {
      const pill = document.getElementById("fs-edit-path");
      const text = pill.textContent || "";
      const parts = text.split(/\s+/);
      const path = parts.slice(1).join(" ").trim(); // after dot
      if (!path || path === "no file") {
        alert("No file selected");
        return;
      }
      const content = document.getElementById("fs-editor").value;
      const res = await fetch("/api/fs/write", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path, content })
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Save error: " + data.error);
      } else {
        alert("Saved: " + path);
      }
    }

    async function fsNewFile() {
      const path = prompt("New file path (relative to FS root):");
      if (!path) return;
      const res = await fetch("/api/fs/write", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path, content: "" })
      });
      const data = await res.json();
      if (!data.ok) alert("Error: " + data.error);
      fsList();
    }

    async function fsNewDir() {
      const path = prompt("New folder path (relative to FS root):");
      if (!path) return;
      const res = await fetch("/api/fs/mkdir", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path })
      });
      const data = await res.json();
      if (!data.ok) alert("Error: " + data.error);
      fsList();
    }

    async function fsDelete() {
      if (!fsSelectedPath) {
        alert("No file/folder selected");
        return;
      }
      if (!confirm("Delete " + fsSelectedPath + " (non-recursive)?")) return;
      const res = await fetch("/api/fs/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path: fsSelectedPath })
      });
      const data = await res.json();
      if (!data.ok) alert("Error: " + data.error);
      fsSelectedPath = null;
      document.getElementById("fs-selected").innerHTML =
        '<span class="pill-dot"></span> selected: none';
      fsList();
    }

    // ---------- Image tab: camera ----------
    async function startCamera() {
      const res = await fetch("/api/camera/start", { method: "POST" });
      const data = await res.json();
      if (data.ok) {
        document.getElementById("cam-status").innerHTML =
          '<span class="pill-dot pill-ok"></span> Camera: ON (' + (data.data.backend || "unknown") + ')';
        document.getElementById("video").src = "/api/video?ts=" + Date.now();
      } else {
        alert("Failed to start camera: " + data.error);
      }
    }

    async function stopCamera() {
      const res = await fetch("/api/camera/stop", { method: "POST" });
      const data = await res.json();
      if (data.ok) {
        document.getElementById("cam-status").innerHTML =
          '<span class="pill-dot pill-bad"></span> Camera: OFF';
        document.getElementById("video").src = "";
      }
    }

    async function snapshot() {
      const img = document.getElementById("video");
      img.src = "/api/camera/frame?ts=" + Date.now();
    }

    async function updateProc() {
      const body = {
        vflip: document.getElementById("vflip").checked,
        hflip: document.getElementById("hflip").checked,
        gray: document.getElementById("gray").checked,
        mode: document.getElementById("proc-mode").value,
        gamma: parseFloat(document.getElementById("gamma").value || "1.0"),
      };
      await fetch("/api/camera/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
    }

    document.getElementById("video").addEventListener("click", async (e) => {
      const img = e.target;
      if (!img.src) return;
      const rect = img.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const marker = document.getElementById("click-marker");
      const px = (x / rect.width) * 100;
      const py = (y / rect.height) * 100;
      marker.style.left = px + "%";
      marker.style.top = py + "%";
      marker.style.display = "block";

      const body = {
        x, y,
        image_width: rect.width,
        image_height: rect.height,
        tag: "click"
      };
      const res = await fetch("/api/data/label_click", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Label save error: " + data.error);
      } else {
        const X = data.data.X;
        const Y = data.data.Y;
        document.getElementById("last-label").innerHTML =
          '<span class="pill-dot pill-ok"></span> last label: X=' + X + ', Y=' + Y;
      }
    });

    // ---------- Datasets ----------
    async function refreshDatasets() {
      const res = await fetch("/api/datasets");
      const data = await res.json();
      if (!data.ok) return;
      const sel = document.getElementById("dataset-select");
      sel.innerHTML = "";
      (data.data.datasets || []).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        if (name === data.data.current) opt.selected = true;
        sel.appendChild(opt);
      });
      const current = data.data.current;
      document.getElementById("dataset-current").innerHTML =
        '<span class="pill-dot"></span> current: ' + current;
      loadDatasetSummary(current);
    }

    async function createDataset() {
      const input = document.getElementById("dataset-new");
      const name = input.value.trim() || document.getElementById("dataset-select").value;
      if (!name) {
        alert("Enter a dataset name or select one");
        return;
      }
      const res = await fetch("/api/datasets/select", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Error: " + data.error);
        return;
      }
      input.value = "";
      refreshDatasets();
      refreshTrainDatasets();
    }

    async function loadDatasetSummary(name) {
      if (!name) return;
      const res = await fetch("/api/datasets/summary?name=" + encodeURIComponent(name));
      const data = await res.json();
      const el = document.getElementById("dataset-summary");
      if (!data.ok) {
        el.textContent = "Error: " + data.error;
        return;
      }
      el.textContent = JSON.stringify(data.data, null, 2);
    }

    // ---------- Manual motors (direct openloop) ----------
    async function sendMotors() {
      const left = parseFloat(document.getElementById("left").value || "0");
      const right = parseFloat(document.getElementById("right").value || "0");
      await fetch("/api/motors/openloop", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ left, right })
      });
    }

    async function stopMotors() {
      await fetch("/api/motors/stop", { method: "POST" });
      document.getElementById("left").value = "0.0";
      document.getElementById("right").value = "0.0";
      resetJoystick();
      lastCmdSend = 0;
    }

    // ---------- Logging (stub) ----------
    async function startLogging() {
      const rate_hz = parseFloat(document.getElementById("log-rate").value);
      const tag = document.getElementById("log-tag").value;
      const res = await fetch("/api/log/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rate_hz, tag })
      });
      const data = await res.json();
      if (data.ok) {
        document.getElementById("log-status").innerHTML =
          '<span class="pill-dot pill-ok"></span> logging: on (' +
          data.data.rate_hz + ' Hz, ' + data.data.tag + ')';
      } else {
        alert("Log start error: " + data.error);
      }
    }

    async function stopLogging() {
      await fetch("/api/log/stop", { method: "POST" });
      document.getElementById("log-status").innerHTML =
        '<span class="pill-dot"></span> logging: off';
    }

    // ---------- Smooth joystick ‚Üí (v,w) ----------
    const JOY_DEADZONE = 0.1;
    const CMD_MAX_HZ = 25;
    let lastCmdSend = 0;

    function applyExpo(x, expo) {
      const sign = x >= 0 ? 1 : -1;
      const ax = Math.abs(x);
      const y = expo * (ax * ax * ax) + (1 - expo) * ax;
      return sign * y;
    }

    function sendVW(v, w, force = false) {
      const now = performance.now();
      const minInterval = 1000 / CMD_MAX_HZ;
      if (!force && (now - lastCmdSend) < minInterval) {
        return;
      }
      lastCmdSend = now;
      fetch("/api/motors/cmd", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ v, w })
      }).catch(() => { });
    }

    let joystickActive = false;

    function setupJoystick() {
      const base = document.getElementById("joystick-base");
      const handle = document.getElementById("joystick-handle");

      base.addEventListener("pointerdown", e => {
        joystickActive = true;
        base.setPointerCapture(e.pointerId);
        updateJoystick(e, base, handle);
      });

      base.addEventListener("pointermove", e => {
        if (!joystickActive) return;
        updateJoystick(e, base, handle);
      });

      base.addEventListener("pointerup", e => {
        base.releasePointerCapture(e.pointerId);
        hardStopJoystick();
      });

      base.addEventListener("pointercancel", e => {
        base.releasePointerCapture(e.pointerId);
        hardStopJoystick();
      });

      // If pointer leaves the joystick area while active
      base.addEventListener("pointerleave", () => {
        if (joystickActive) {
          hardStopJoystick();
        }
      });

      // If the window loses focus, stop
      window.addEventListener("blur", () => {
        if (joystickActive) {
          hardStopJoystick();
        }
      });

      // If tab becomes hidden, stop
      document.addEventListener("visibilitychange", () => {
        if (document.hidden && joystickActive) {
          hardStopJoystick();
        }
      });


    }

    function resetJoystick() {
      const handle = document.getElementById("joystick-handle");
      handle.style.left = "50%";
      handle.style.top = "50%";
    }

    function updateJoystick(e, base, handle) {
      const rect = base.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;

      let dx = e.clientX - cx;
      let dy = e.clientY - cy;

      const maxR = rect.width / 2;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist > maxR) {
        dx *= maxR / dist;
        dy *= maxR / dist;
      }

      const nx = dx / maxR;   // [-1, 1] left/right
      const ny = dy / maxR;   // [-1, 1] up/down

      // Deadzone
      const mag = Math.sqrt(nx * nx + ny * ny);
      if (mag < JOY_DEADZONE) {
        resetJoystick();
        document.getElementById("left").value = "0.00";
        document.getElementById("right").value = "0.00";
        sendVW(0.0, 0.0, true);
        return;
      }

      // Handle visual
      handle.style.left = (50 + (nx * 50)) + "%";
      handle.style.top = (50 + (ny * 50)) + "%";

      const speedGain = parseFloat(document.getElementById("joy-speed").value || "1.0");
      const steerGain = parseFloat(document.getElementById("joy-steer").value || "1.0");

      // IMPORTANT: raw mapping
      let v_raw = -ny;  // up = forward
      let w_raw = -nx;   // right = positive turn (flip sign if steering inverted)

      const expoTrans = 0.3;
      const expoRot = 0.4;

      let v = applyExpo(v_raw, expoTrans) * speedGain;
      let w = applyExpo(w_raw, expoRot) * steerGain;

      // clamp to [-1,1]
      v = Math.max(-1, Math.min(1, v));
      w = Math.max(-1, Math.min(1, w));

      // Estimate L/R for UI, match server's no-normalize mix
      let left = v - w;
      let right = v + w;

      // Clamp each wheel individually to [-1, 1] (no shared rescale)
      left = Math.max(-1, Math.min(1, left));
      right = Math.max(-1, Math.min(1, right));

      document.getElementById("left").value = left.toFixed(2);
      document.getElementById("right").value = right.toFixed(2);


      // Send to smooth controller
      sendVW(v, w, false);
    }

    function hardStopJoystick() {
      joystickActive = false;
      resetJoystick();
      document.getElementById("left").value = "0.0";
      document.getElementById("right").value = "0.0";
      lastCmdSend = 0;

      // Tell the smooth controller to zero v,w immediately
      sendVW(0.0, 0.0, true);

      // Also call the stop endpoint to zero currents + motors
      fetch("/api/motors/stop", { method: "POST" }).catch(() => { });
    }


    // ---------- Train tab ----------
    async function refreshTrainDatasets() {
      const res = await fetch("/api/datasets");
      const data = await res.json();
      if (!data.ok) return;
      const sel = document.getElementById("train-dataset");
      sel.innerHTML = "";
      (data.data.datasets || []).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        if (name === data.data.current) opt.selected = true;
        sel.appendChild(opt);
      });

      const current = sel.value || data.data.current;
      loadTrainDatasetSummary(current);
      sel.onchange = () => loadTrainDatasetSummary(sel.value);
    }

    async function loadTrainDatasetSummary(name) {
      if (!name) return;
      const res = await fetch("/api/datasets/summary?name=" + encodeURIComponent(name));
      const data = await res.json();
      const el = document.getElementById("train-dataset-summary");
      if (!data.ok) {
        el.textContent = "Error: " + data.error;
        return;
      }
      el.textContent = JSON.stringify(data.data, null, 2);
    }

    async function startTrain() {
      const dataset = document.getElementById("train-dataset").value;
      const epochs = parseInt(document.getElementById("train-epochs").value || "10", 10);
      const learning_rate = parseFloat(document.getElementById("train-lr").value || "0.001");
      const batch_size = parseInt(document.getElementById("train-batch").value || "32", 10);
      const res = await fetch("/api/train/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dataset, epochs, learning_rate, batch_size })
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Train start error: " + data.error);
        return;
      }
      pollTrainStatus();
    }

    async function pollTrainStatus() {
      const res = await fetch("/api/train/status");
      const data = await res.json();
      const el = document.getElementById("train-status");
      if (!data.ok) {
        el.textContent = "Error: " + data.error;
        return;
      }
      el.textContent = JSON.stringify(data.data, null, 2);
      if (data.data.running) {
        setTimeout(pollTrainStatus, 500);
      }
    }

    // ---------- Deploy tab ----------
    async function startAutopilot() {
      const res = await fetch("/api/deploy/start", { method: "POST" });
      const data = await res.json();
      if (!data.ok) alert("Error: " + data.error);
      pollDeployStatus();
    }

    async function stopAutopilot() {
      const res = await fetch("/api/deploy/stop", { method: "POST" });
      const data = await res.json();
      if (!data.ok) alert("Error: " + data.error);
      pollDeployStatus();
    }

    async function pollDeployStatus() {
      const res = await fetch("/api/deploy/status");
      const data = await res.json();
      const el = document.getElementById("deploy-status");
      if (!data.ok) {
        el.textContent = "Error: " + data.error;
        return;
      }
      el.textContent = JSON.stringify(data.data, null, 2);

      const g = data.data.gains || {};
      document.getElementById("deploy-throttle").value = g.throttle_gain ?? 1.0;
      document.getElementById("deploy-steering").value = g.steering_gain ?? 1.0;
      document.getElementById("deploy-expo").value = g.expo ?? 1.0;
      document.getElementById("deploy-drive").checked = !!data.data.drive_motors;
    }

    async function updateDeployGains() {
      const throttle_gain = parseFloat(document.getElementById("deploy-throttle").value || "1.0");
      const steering_gain = parseFloat(document.getElementById("deploy-steering").value || "1.0");
      const expo = parseFloat(document.getElementById("deploy-expo").value || "1.0");
      const drive_motors = document.getElementById("deploy-drive").checked;

      const res = await fetch("/api/deploy/gains", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ throttle_gain, steering_gain, expo, drive_motors })
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Update gains error: " + data.error);
        return;
      }
      pollDeployStatus();
    }

    // ---------- Bootstrap ----------
    async function bootstrap() {
      fsList();
      refreshDatasets();
      refreshTrainDatasets();
      setupJoystick();

      const res = await fetch("/api/health");
      const data = await res.json();
      if (data.ok) {
        document.getElementById("dataset-current").innerHTML =
          '<span class="pill-dot"></span> current: ' + data.data.current_dataset;
        if (data.data.camera_on) {
          document.getElementById("cam-status").innerHTML =
            '<span class="pill-dot pill-ok"></span> Camera: ON (' + data.data.camera_backend + ')';
          document.getElementById("video").src = "/api/video?ts=" + Date.now();
        }
      }
    }

    bootstrap();
  </script>
</body>

</html>