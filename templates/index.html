<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AI Car Studio</title>
  <style>
    :root {
      --bg: #050509;
      --card: #141420;
      --accent: #4f7dff;
      --text-main: #f5f5ff;
      --text-soft: #9ca3c7;
    }
    body {
      font-family: sans-serif;
      padding: 16px;
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
    }
    .app-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
    h1 { margin: 0; font-size: 20px; }
    
    /* Tabs */
    .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
    .tab-btn {
      background: rgba(255,255,255,0.1); border: none; color: #fff;
      padding: 8px 16px; border-radius: 4px; cursor: pointer;
    }
    .tab-btn.active { background: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Layout */
    .split { display: flex; gap: 20px; }
    .col { flex: 1; background: var(--card); padding: 15px; border-radius: 8px; }
    
    /* Elements */
    .row { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    button {
      padding: 6px 12px; cursor: pointer; background: #333; color: white; border: 1px solid #555; border-radius: 4px;
    }
    button.primary { background: var(--accent); border-color: var(--accent); }
    input, select { padding: 5px; background: #222; color: white; border: 1px solid #444; border-radius: 4px; }
    
    /* Video */
    #video-container { position: relative; display: inline-block; }
    #video {
      width: 224px; height: 224px; background: #000; object-fit: cover;
      border: 2px solid #333;
    }
    #click-marker {
      position: absolute; width: 10px; height: 10px; background: red;
      border-radius: 50%; transform: translate(-50%, -50%); display: none; pointer-events: none;
    }
    
    /* Logs */
    pre { background: #000; padding: 10px; max-height: 200px; overflow: auto; font-size: 12px; }
  </style>
</head>
<body>

<div class="app-header">
  <h1>AI Car Studio (V3)</h1>
  <div id="status-bar">FPS: <span id="fps-display">0</span></div>
</div>

<div class="tabs">
  <button class="tab-btn active" onclick="showTab('image')">Image & Data</button>
  <button class="tab-btn" onclick="showTab('train')">Train</button>
  <button class="tab-btn" onclick="showTab('deploy')">Deploy</button>
  <button class="tab-btn" onclick="showTab('file')">Files</button>
</div>

<!-- IMAGE TAB -->
<div id="tab-image" class="tab-content active">
  <div class="split">
    <div class="col">
      <h3>Camera</h3>
      <div class="row">
        <button class="primary" onclick="api('/api/camera/start', 'POST')">Start Cam</button>
        <button onclick="api('/api/camera/stop', 'POST')">Stop</button>
        <button onclick="document.getElementById('video').src='/api/camera/frame?t='+Date.now()">Snapshot</button>
      </div>
      <div id="video-container">
        <img id="video" src="" alt="Camera Stream">
        <div id="click-marker"></div>
      </div>
      <p style="font-size: 12px; color: #aaa;">Click image to label point.</p>
    </div>
    <div class="col">
      <h3>Datasets</h3>
      <div class="row">
        <select id="dataset-select"></select>
        <button onclick="refreshDatasets()">Refresh</button>
      </div>
      <div class="row">
        <input type="text" id="new-dataset" placeholder="New Dataset Name">
        <button onclick="createDataset()">Create</button>
      </div>
      <pre id="dataset-info">No dataset selected</pre>
    </div>
  </div>
</div>

<!-- TRAIN TAB -->
<div id="tab-train" class="tab-content">
  <div class="col">
    <h3>Training</h3>
    <div class="row">
      <label>Dataset: <select id="train-dataset-select"></select></label>
      <button onclick="refreshDatasets()">Refresh</button>
    </div>
    <div class="row">
      <button class="primary" onclick="startTrain()">Start Training</button>
      <button onclick="validateDataset()">Validate Dataset</button>
    </div>
    <pre id="train-log">Ready to train.</pre>
  </div>
</div>

<!-- DEPLOY TAB -->
<div id="tab-deploy" class="tab-content">
  <div class="col">
    <h3>Autopilot / Deploy</h3>
    <div class="row">
      <label>Model: <select id="model-select"><option value="">(None)</option></select></label>
      <button onclick="refreshModels()">Refresh Models</button>
    </div>
    <div class="row">
      <button onclick="testFrame()">Test Current Frame</button>
    </div>
    <div class="row">
      <button class="primary" onclick="api('/api/deploy/start', 'POST')">Start Autopilot</button>
      <button onclick="api('/api/deploy/stop', 'POST')">Stop</button>
    </div>
    <pre id="deploy-log">Deploy status...</pre>
  </div>
</div>

<!-- FILE TAB -->
<div id="tab-file" class="tab-content">
  <div class="split">
    <div class="col">
      <h3>File Browser</h3>
      <div class="row"><input id="fs-path" value="."><button onclick="listFiles()">Go</button></div>
      <div id="fs-list"></div>
    </div>
    <div class="col">
      <h3>Editor</h3>
      <textarea id="file-content" style="width:100%; height: 300px; background:#111; color:#ddd;"></textarea>
    </div>
  </div>
</div>

<script>
// --- UTILS ---
async function api(url, method="GET", body=null) {
  const opts = { method };
  if (body) {
    opts.headers = { "Content-Type": "application/json" };
    opts.body = JSON.stringify(body);
  }
  try {
    const res = await fetch(url, opts);
    const type = res.headers.get("content-type");
    if (type && type.includes("text/html")) throw new Error("Server returned HTML (404/500)");
    return await res.json();
  } catch (e) {
    console.error(e);
    alert("API Error: " + e.message);
    return { ok: false };
  }
}

function showTab(id) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-'+id).classList.add('active');
}

// --- DATASETS ---
async function refreshDatasets() {
  const data = await api('/api/datasets');
  if (!data.ok) return;
  const opts = data.data.datasets.map(d => `<option value="${d}">${d}</option>`).join('');
  document.getElementById('dataset-select').innerHTML = opts;
  document.getElementById('train-dataset-select').innerHTML = opts;
  updateDatasetInfo();
}

async function createDataset() {
  const name = document.getElementById('new-dataset').value;
  if(!name) return;
  await api('/api/datasets/select', 'POST', {name});
  refreshDatasets();
}

async function updateDatasetInfo() {
  const name = document.getElementById('dataset-select').value;
  if(!name) return;
  const data = await api('/api/datasets/summary?name='+name);
  if(data.ok) document.getElementById('dataset-info').innerText = JSON.stringify(data.data, null, 2);
}

// --- MODELS ---
async function refreshModels() {
  const data = await api('/api/models');
  if (!data.ok) return;
  const opts = data.data.items.map(m => `<option value="${m.name}">${m.name} (${m.size_kb}KB)</option>`).join('');
  document.getElementById('model-select').innerHTML = opts || '<option value="">No models found</option>';
}

async function testFrame() {
  const res = await api('/api/deploy/test_frame');
  document.getElementById('deploy-log').innerText = JSON.stringify(res.data, null, 2);
  
  // Ghost overlay
  if (res.ok && res.data.click_X) {
     const mk = document.getElementById('click-marker');
     // Map 0..149 to 0..100%
     mk.style.left = (res.data.click_X / 149 * 100) + "%";
     mk.style.top = (res.data.click_Y / 149 * 100) + "%";
     mk.style.display = 'block';
  }
}

async function startTrain() {
  const ds = document.getElementById('train-dataset-select').value;
  const res = await api('/api/train/start', 'POST', {dataset: ds});
  document.getElementById('train-log').innerText = JSON.stringify(res, null, 2);
}

async function validateDataset() {
  const ds = document.getElementById('train-dataset-select').value;
  const res = await api('/api/train/validate?dataset='+ds);
  document.getElementById('train-log').innerText = JSON.stringify(res.data, null, 2);
}

// --- INIT ---
async function init() {
  setInterval(async () => {
    const h = await api('/api/health');
    if(h.ok) document.getElementById('fps-display').innerText = h.data.camera_fps;
  }, 2000);
  
  refreshDatasets();
  refreshModels();
  
  // Click Labeling
  document.getElementById('video').onclick = async (e) => {
    const rect = e.target.getBoundingClientRect();
    const x = e.clientX - rect.left; 
    const y = e.clientY - rect.top;
    
    // Visual
    const mk = document.getElementById('click-marker');
    mk.style.left = x + 'px'; mk.style.top = y + 'px'; mk.style.display = 'block';
    
    // API
    await api('/api/data/label_click', 'POST', {
      x, y, image_width: rect.width, image_height: rect.height
    });
  };
  
  // Start Video Stream
  document.getElementById('video').src = "/api/video";
}

// File Browser Logic (Simplified)
async function listFiles() {
  const path = document.getElementById('fs-path').value;
  const res = await api('/api/fs/list?path='+path);
  if(res.ok) {
    document.getElementById('fs-list').innerHTML = res.data.entries.map(e => 
      `<div onclick="loadFile('${path}/${e.name}')" style="cursor:pointer; padding:2px;">${e.is_dir?'üìÅ':'üìÑ'} ${e.name}</div>`
    ).join('');
  }
}
async function loadFile(path) {
  const res = await api('/api/fs/read?path='+path);
  if(res.ok) document.getElementById('file-content').value = res.data.content;
}

init();
</script>
</body>
</html>