<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Car Studio - Full Power</title>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #58a6ff; --success: #2ea043; --danger: #da3633; }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 10px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); }
        h1, h2, h3, h4 { margin: 0 0 10px 0; font-weight: 600; color: #fff; }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; }
        .badge { background: #21262d; border: 1px solid var(--border); padding: 2px 8px; border-radius: 12px; font-size: 0.8em; }
        .pill { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 99px; background: rgba(255,255,255,0.1); font-size: 0.8em; margin-left: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; background: #888; }
        .dot.ok { background: var(--success); }
        .dot.bad { background: var(--danger); }

        .grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        @media(max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 6px; padding: 15px; margin-bottom: 15px; }
        .row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        
        button { background: #21262d; border: 1px solid var(--border); color: var(--text); padding: 5px 12px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        button:hover { background: #30363d; border-color: #8b949e; }
        button.primary { background: #1f6feb; border-color: rgba(27,31,35,0.15); color: #fff; }
        button.primary:hover { background: #1158c7; }
        button.danger { color: var(--danger); border-color: var(--danger); }
        
        input, select { background: #0d1117; border: 1px solid var(--border); color: #fff; padding: 4px 8px; border-radius: 4px; }
        
        .video-container { position: relative; width: 224px; height: 224px; background: #000; border: 2px solid var(--border); border-radius: 4px; margin: 0 auto; }
        #video { width: 100%; height: 100%; object-fit: cover; cursor: crosshair; }
        #click-marker { position: absolute; width: 12px; height: 12px; border: 2px solid var(--accent); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; display: none; box-shadow: 0 0 4px white; }
        
        #joystick-zone { width: 200px; height: 200px; border-radius: 50%; background: #21262d; border: 2px solid var(--border); position: relative; margin: 10px auto; touch-action: none; }
        #joystick-knob { width: 60px; height: 60px; border-radius: 50%; background: var(--accent); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.8; pointer-events: none; }

        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: var(--accent); font-weight: bold; color: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        pre { background: #0d1117; padding: 10px; border-radius: 6px; overflow-x: auto; font-size: 0.85em; color: #8b949e; }
        .debug-img { width: 100%; border-radius: 4px; border: 1px solid var(--border); display: none; }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex;align-items:center;">
        <h3>AI Car Studio <span style="font-size:0.6em;opacity:0.6;font-weight:400;">v3.5 FP</span></h3>
        <span class="pill" id="fps-pill"><div class="dot"></div> FPS: 0</span>
    </div>
    <div>
        <span class="badge" id="cam-badge">Cam: OFF</span>
        <span class="badge" id="log-badge">Log: OFF</span>
    </div>
</div>

<div class="grid">
    <div>
        <div class="panel">
            <div class="row" style="justify-content: center;">
                <button onclick="api('camera/start', {}, updateState)">Start Cam</button>
                <button onclick="api('camera/stop', {}, updateState)">Stop</button>
            </div>
            <div class="video-container">
                <img id="video" onclick="handleLabel(event)">
                <div id="click-marker"></div>
            </div>
            <div class="row" style="justify-content: center; margin-top:5px; font-size:0.8em;">
                <label><input type="checkbox" id="ghost-check" onchange="toggleGhost(this.checked)"> AI Ghost</label>
                <span id="label-status" style="margin-left:10px; color: #8b949e;">No label</span>
            </div>
        </div>

        <div class="panel">
            <h4>Manual Control</h4>
            <div id="joystick-zone"><div id="joystick-knob"></div></div>
            <div class="row" style="justify-content: center;">
                <span style="font-family: monospace;">L: <span id="val-l">0.0</span> R: <span id="val-r">0.0</span></span>
                <button class="danger" onclick="stopMotors()">STOP</button>
            </div>
            <div class="row">
                <button onclick="api('log/start')">Rec Start</button>
                <button onclick="api('log/stop')">Rec Stop</button>
            </div>
        </div>
    </div>

    <div>
        <div class="tabs">
            <div class="tab active" onclick="setTab('train')">Train</div>
            <div class="tab" onclick="setTab('deploy')">Deploy</div>
            <div class="tab" onclick="setTab('settings')">Settings</div>
        </div>

        <div id="view-train" class="tab-content active">
            <div class="panel">
                <div class="row">
                    <label>Dataset: <select id="ds-select"></select></label>
                    <button onclick="refreshDatasets()">↻</button>
                    <input type="text" id="ds-new" placeholder="New..." style="width:80px">
                    <button onclick="api('datasets/select', {name: getVal('ds-new') || getVal('ds-select')})">Set</button>
                </div>
                <div class="row">
                    <label>Epochs: <input type="number" id="epochs" value="10" style="width:50px"></label>
                    <button class="primary" onclick="startTrain()">Start Training</button>
                </div>
                <pre id="train-log">Ready.</pre>
            </div>

            <div class="panel">
                <h4>Validation & Testing</h4>
                <div class="row">
                    <button onclick="validate()">Validate (Full Dataset)</button>
                    <button onclick="testFrame()">Test Current Frame</button>
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="flex:1"><pre id="valid-res">Metrics will appear here.</pre></div>
                    <div style="flex:1"><img id="test-img" class="debug-img"></div>
                </div>
            </div>
        </div>

        <div id="view-deploy" class="tab-content">
            <div class="panel">
                <div class="row">
                    <label>Model: <select id="model-select"></select></label>
                    <button onclick="refreshModels()">↻</button>
                    <button onclick="convertInt8()">Quantize (Int8)</button>
                </div>
            </div>

            <div class="panel">
                <h4>Autopilot</h4>
                <div class="row">
                    <button class="primary" onclick="startAP()">ENGAGE</button>
                    <button class="danger" onclick="stopAP()">DISENGAGE</button>
                </div>
                <div class="row">
                    <label>Throttle: <input type="number" id="gain-t" value="1.0" step="0.1" style="width:50px"></label>
                    <label>Steer: <input type="number" id="gain-s" value="1.0" step="0.1" style="width:50px"></label>
                    <label><input type="checkbox" id="drv-en"> Motors Enabled</label>
                </div>
                <div class="row">
                    <label>Mode: <select id="ap-mode"><option value="assist">Assist</option><option value="auto">Auto</option></select></label>
                    <button onclick="updateGains()">Apply Settings</button>
                </div>
                <pre id="ap-status">Status...</pre>
            </div>
        </div>

        <div id="view-settings" class="tab-content">
            <div class="panel">
                <h4>Camera</h4>
                <div class="row">
                    <label><input type="checkbox" id="vflip" onchange="camSettings()"> V-Flip</label>
                    <label><input type="checkbox" id="hflip" onchange="camSettings()"> H-Flip</label>
                    <label>Mode: <select id="cmode" onchange="camSettings()"><option value="raw">Raw</option><option value="gray">Gray</option><option value="edges">Edges</option></select></label>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const getVal = (id) => document.getElementById(id).value;
    const setHtml = (id, html) => { const el = document.getElementById(id); if(el) el.innerHTML = html; };
    
    async function api(endpoint, data=null, cb=null) {
        try {
            const opts = data ? { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) } : {};
            const res = await fetch('/api/' + endpoint, opts);
            const json = await res.json();
            if (cb) cb(json);
            return json;
        } catch(e) { console.error(e); }
    }

    function updateState() {
        api('health', null, d => {
            if(d.ok) {
                const dd = d.data;
                setHtml('cam-badge', `Cam: ${dd.camera_on ? 'ON' : 'OFF'}`);
                setHtml('fps-pill', `<div class="dot ${dd.camera_on?'ok':'bad'}"></div> FPS: ${dd.camera_fps}`);
                if(dd.camera_on) document.getElementById('video').src = "/api/video?t=" + Date.now();
            }
        });
        api('deploy/status', null, d => {
            if(d.ok) {
                document.getElementById('ap-status').textContent = JSON.stringify(d.data, null, 2);
                const s = d.data;
                document.getElementById('gain-t').value = s.gains.throttle_gain;
                document.getElementById('drv-en').checked = s.drive_motors;
            }
        });
    }
    setInterval(updateState, 2000); 

    function setTab(name) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('view-'+name).classList.add('active');
    }

    function camSettings() {
        api('camera/settings', {
            vflip: document.getElementById('vflip').checked,
            hflip: document.getElementById('hflip').checked,
            mode: document.getElementById('cmode').value
        });
    }

    function handleLabel(e) {
        const rect = e.target.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const m = document.getElementById('click-marker');
        m.style.left = x + 'px'; m.style.top = y + 'px';
        m.style.display = 'block';
        api('data/label_click', { x: x, y: y, image_width: rect.width, image_height: rect.height }, d => {
            if(d.ok) document.getElementById('label-status').textContent = "Saved: " + d.data.saved;
        });
    }

    const joy = document.getElementById('joystick-zone');
    const knob = document.getElementById('joystick-knob');
    let driving = false;

    joy.addEventListener('pointerdown', e => { driving = true; joy.setPointerCapture(e.pointerId); moveJoy(e); });
    joy.addEventListener('pointermove', e => { if(driving) moveJoy(e); });
    joy.addEventListener('pointerup', stopJoy);
    joy.addEventListener('pointercancel', stopJoy);

    function stopJoy() {
        driving = false; knob.style.left = '50%'; knob.style.top = '50%'; stopMotors();
    }

    function moveJoy(e) {
        const rect = joy.getBoundingClientRect();
        const cx = rect.width / 2; const cy = rect.height / 2;
        let dx = e.clientX - rect.left - cx; let dy = e.clientY - rect.top - cy;
        const dist = Math.sqrt(dx*dx + dy*dy); const maxR = cx - 30;
        if (dist > maxR) { dx *= maxR / dist; dy *= maxR / dist; }
        knob.style.left = (cx + dx) + 'px'; knob.style.top = (cy + dy) + 'px';
        const fwd = -(dy / maxR); const turn = (dx / maxR);
        const l = fwd + turn; const r = fwd - turn;
        document.getElementById('val-l').textContent = l.toFixed(2);
        document.getElementById('val-r').textContent = r.toFixed(2);
        api('motors/openloop', {left: l, right: r});
    }
    
    function stopMotors() {
        api('motors/stop');
        document.getElementById('val-l').textContent = "0.0";
        document.getElementById('val-r').textContent = "0.0";
    }

    function refreshDatasets() {
        api('datasets', null, d => {
            const s = document.getElementById('ds-select');
            s.innerHTML = '';
            d.data.datasets.forEach(n => s.add(new Option(n, n)));
            s.value = d.data.current;
        });
    }
    
    function startTrain() {
        api('train/start', {dataset: document.getElementById('ds-select').value, epochs: document.getElementById('epochs').value});
        pollTrain();
    }
    
    function pollTrain() {
        api('train/status', null, d => {
            document.getElementById('train-log').textContent = JSON.stringify(d.data, null, 2);
            if(d.data.running) setTimeout(pollTrain, 1000);
        });
    }

    function validate() {
        document.getElementById('valid-res').textContent = "Running...";
        api('train/validate?dataset='+document.getElementById('ds-select').value, null, d => {
            document.getElementById('valid-res').textContent = JSON.stringify(d.data, null, 2);
        });
    }

    function testFrame() {
        api('deploy/test_frame?model='+document.getElementById('model-select').value, null, d => {
            if(d.ok) {
                const img = document.getElementById('test-img');
                img.src = d.data.debug_image;
                img.style.display = 'block';
                document.getElementById('valid-res').textContent = `L:${d.data.left} R:${d.data.right}`;
            } else {
                document.getElementById('valid-res').textContent = "Error: " + d.error;
            }
        });
    }

    function refreshModels() {
        api('models', null, d => {
            const s = document.getElementById('model-select');
            s.innerHTML = '';
            d.data.models.forEach(m => s.add(new Option(m.name, m.name)));
            if(d.data.current) s.value = d.data.current;
        });
    }

    function startAP() { api('deploy/start', {model: document.getElementById('model-select').value}); }
    function stopAP() { api('deploy/stop'); }
    
    function updateGains() {
        api('deploy/gains', {
            throttle_gain: document.getElementById('gain-t').value,
            steering_gain: document.getElementById('gain-s').value,
            drive_motors: document.getElementById('drv-en').checked,
            mode: document.getElementById('ap-mode').value,
            assist_blend: document.getElementById('deploy-assist').value
        });
    }
    
    function convertInt8() {
        const m = document.getElementById('model-select').value;
        if(!m) return;
        api('models/convert', {source: m}, d => {
            if(d.ok) { alert("Converted: " + d.data.created); refreshModels(); }
            else alert("Error: " + d.error);
        });
    }

    let ghostInt;
    function toggleGhost(on) {
        if(ghostInt) clearInterval(ghostInt);
        const m = document.getElementById('click-marker');
        if(!on) { m.style.display='none'; return; }
        
        ghostInt = setInterval(() => {
            fetch('/api/deploy/test_frame?model='+document.getElementById('model-select').value)
                .then(r=>r.json()).then(d => {
                    if(d.ok) {
                        const x = (d.data.click_X / 149.0) * 224;
                        const y = (d.data.click_Y / 149.0) * 224;
                        m.style.left = x + 'px'; m.style.top = y + 'px';
                        m.style.display = 'block';
                    }
                });
        }, 200);
    }

    refreshDatasets();
    refreshModels();
    document.getElementById('video').src = "/api/video";
</script>
</body>
</html>