<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>AI Car Studio</title>
  <style>
    :root {
      --bg: #02030a;
      --bg-grid: rgba(255, 255, 255, 0.03);
      --card: rgba(10, 12, 30, 0.9);
      --card-border: rgba(128, 179, 255, 0.25);
      --accent: #5b8cff;
      --accent-soft: rgba(91, 140, 255, 0.2);
      --accent-2: #ff6fb1;
      --accent-3: #4ef2c5;
      --text-main: #f5f5ff;
      --text-soft: #9ca3c7;
      --pill-bg: rgba(10, 14, 40, 0.9);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      padding: 16px;
      margin: 0;
      min-height: 100vh;
      color: var(--text-main);
      background: radial-gradient(circle at top left, #1f2450 0, transparent 55%),
        radial-gradient(circle at bottom right, #38144f 0, transparent 55%),
        var(--bg);
      position: relative;
      overflow-x: hidden;
    }

    /* Animated grid background */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(var(--bg-grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--bg-grid) 1px, transparent 1px);
      background-size: 40px 40px;
      opacity: 0.35;
      pointer-events: none;
      z-index: -2;
      animation: grid-pan 35s linear infinite;
    }

    @keyframes grid-pan {
      from {
        transform: translate3d(0, 0, 0);
      }

      to {
        transform: translate3d(-80px, -80px, 0);
      }
    }

    /* subtle vignette */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at center, transparent 0, rgba(0, 0, 0, 0.9) 80%);
      pointer-events: none;
      z-index: -1;
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 24px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #f8f8ff;
    }

    h2 {
      margin-top: 0;
      font-size: 18px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    h2::before {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 3px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 10px rgba(91, 140, 255, 0.7);
    }

    p {
      color: var(--text-soft);
    }

    /* Header + HUD */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      gap: 12px;
    }

    .subtitle {
      margin: 0;
      font-size: 13px;
      color: var(--text-soft);
    }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .hud {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }

    .hud-chip {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(150, 200, 255, 0.4);
      background: radial-gradient(circle at top left, rgba(150, 200, 255, 0.2), rgba(4, 6, 20, 0.95));
      color: #d9e6ff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .hud-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #f97373;
      box-shadow: 0 0 8px rgba(249, 115, 115, 0.7);
    }

    .hud-dot.ok {
      background: #4ade80;
      box-shadow: 0 0 8px rgba(74, 222, 128, 0.7);
    }

    .hud-label {
      opacity: 0.6;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      position: relative;
    }

    .tab-btn {
      border: 1px solid transparent;
      background: rgba(8, 10, 30, 0.6);
      color: var(--text-soft);
      padding: 6px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.18s all ease;
      backdrop-filter: blur(16px);
    }

    .tab-icon {
      font-size: 13px;
      opacity: 0.8;
    }

    .tab-btn::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: transparent;
    }

    .tab-btn.active {
      background: radial-gradient(circle at top left, rgba(91, 140, 255, 0.4), rgba(18, 24, 60, 0.95));
      border-color: rgba(144, 205, 255, 0.9);
      color: var(--text-main);
      box-shadow:
        0 0 0 1px rgba(193, 225, 255, 0.3),
        0 10px 24px rgba(0, 0, 0, 0.7);
      transform: translateY(-1px);
    }

    .tab-btn.active::before {
      background: var(--accent-3);
      box-shadow: 0 0 10px rgba(78, 242, 197, 0.7);
    }

    .tab-content {
      display: none;
      border-radius: 18px;
      padding: 14px 14px 18px 14px;
      background:
        radial-gradient(circle at top left, rgba(120, 180, 255, 0.18), transparent 50%),
        radial-gradient(circle at bottom right, rgba(255, 111, 177, 0.12), transparent 50%),
        linear-gradient(135deg, rgba(8, 10, 30, 0.96), rgba(5, 6, 18, 0.98));
      border: 1px solid rgba(135, 190, 255, 0.4);
      box-shadow:
        0 24px 48px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(0, 0, 0, 0.2);
      margin-bottom: 14px;
      position: relative;
      overflow: hidden;
    }

    .tab-content::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 10% 0%, rgba(255, 255, 255, 0.06), transparent 60%),
        radial-gradient(circle at 90% 100%, rgba(255, 255, 255, 0.05), transparent 60%);
      opacity: 0.6;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .tab-content.active {
      display: block;
      animation: card-in 0.25s ease-out;
    }

    @keyframes card-in {
      from {
        opacity: 0;
        transform: translateY(6px) scale(0.99);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Buttons & inputs */
    button {
      margin: 3px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(150, 190, 255, 0.25);
      background: radial-gradient(circle at top left, rgba(140, 190, 255, 0.22), rgba(10, 14, 40, 0.95));
      color: var(--text-main);
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.18s all ease;
    }

    button:hover {
      border-color: rgba(205, 231, 255, 0.8);
      box-shadow:
        0 0 0 1px rgba(205, 231, 255, 0.4),
        0 10px 24px rgba(0, 0, 0, 0.8);
      transform: translateY(-1px);
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-color: transparent;
      color: #fff;
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.06),
        0 14px 30px rgba(0, 0, 0, 0.9);
      position: relative;
      overflow: hidden;
    }

    button.primary::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, 0.4) 40%, transparent 80%);
      opacity: 0;
      transform: translateX(-80%);
      pointer-events: none;
    }

    button.primary:hover::after {
      opacity: 0.6;
      transform: translateX(80%);
      transition: transform 0.4s ease, opacity 0.3s ease;
    }

    input[type="number"],
    input[type="text"],
    select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(150, 190, 255, 0.4);
      background: radial-gradient(circle at top left, rgba(120, 175, 255, 0.15), rgba(5, 7, 20, 0.95));
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      min-width: 60px;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.5);
    }

    input[type="text"] {
      width: 160px;
    }

    input[type="checkbox"] {
      margin-right: 4px;
      accent-color: var(--accent-3);
    }

    select {
      min-width: 120px;
    }

    label {
      font-size: 13px;
      color: var(--text-soft);
    }

    /* Video */
    #video {
      border-radius: 14px;
      background: #000;
      max-width: 100%;
      border: 1px solid rgba(185, 215, 255, 0.6);
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.95),
        0 0 0 1px rgba(0, 0, 0, 0.9);
      cursor: crosshair;
      position: relative;
    }

    .video-frame {
      position: relative;
      display: inline-block;
      border-radius: 16px;
      padding: 4px;
      background: radial-gradient(circle at top left, rgba(91, 140, 255, 0.4), rgba(0, 0, 0, 0.9));
      box-shadow:
        0 0 0 1px rgba(160, 200, 255, 0.6),
        0 18px 48px rgba(0, 0, 0, 1);
    }

    .video-overlay-corners {
      position: absolute;
      inset: 4px;
      pointer-events: none;
    }

    .video-corner {
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 2px solid rgba(132, 210, 255, 0.7);
      box-shadow: 0 0 12px rgba(132, 210, 255, 0.7);
    }

    .video-corner.tl {
      left: -2px;
      top: -2px;
      border-right: none;
      border-bottom: none;
    }

    .video-corner.tr {
      right: -2px;
      top: -2px;
      border-left: none;
      border-bottom: none;
    }

    .video-corner.bl {
      left: -2px;
      bottom: -2px;
      border-right: none;
      border-top: none;
    }

    .video-corner.br {
      right: -2px;
      bottom: -2px;
      border-left: none;
      border-top: none;
    }

    pre,
    textarea {
      width: 100%;
      box-sizing: border-box;
      background: radial-gradient(circle at top left, rgba(80, 120, 200, 0.18), rgba(4, 5, 15, 0.98));
      color: var(--text-main);
      border-radius: 12px;
      border: 1px solid rgba(140, 190, 255, 0.5);
      padding: 8px;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 14px 26px rgba(0, 0, 0, 0.95);
    }

    textarea {
      min-height: 200px;
      resize: vertical;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .fs-list {
      max-height: 260px;
      overflow-y: auto;
      border-radius: 12px;
      padding: 4px;
      background: radial-gradient(circle at top left, rgba(80, 120, 200, 0.16), rgba(2, 4, 12, 0.96));
      border: 1px solid rgba(140, 190, 255, 0.5);
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 14px 26px rgba(0, 0, 0, 0.95);
    }

    .fs-entry {
      display: flex;
      justify-content: space-between;
      padding: 4px 7px;
      cursor: pointer;
      font-size: 13px;
      border-radius: 8px;
      color: var(--text-soft);
      transition: 0.12s background ease, 0.12s transform ease;
    }

    .fs-entry:hover {
      background: rgba(180, 210, 255, 0.14);
      color: var(--text-main);
      transform: translateY(-1px);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(165, 210, 255, 0.7);
      font-size: 11px;
      background: radial-gradient(circle at top left, rgba(140, 190, 255, 0.3), rgba(7, 10, 30, 0.96));
      color: var(--text-soft);
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #9ca3ff;
      box-shadow: 0 0 10px rgba(156, 163, 255, 0.8);
    }

    .pill-ok .pill-dot {
      background: #4ade80;
      box-shadow: 0 0 10px rgba(74, 222, 128, 0.8);
    }

    .pill-bad .pill-dot {
      background: #f97373;
      box-shadow: 0 0 10px rgba(249, 115, 115, 0.9);
    }

    .left-col,
    .right-col {
      flex: 1 1 0;
      min-width: 0;
    }

    .split {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }

    hr.soft {
      border: none;
      border-top: 1px dashed rgba(185, 220, 255, 0.5);
      margin: 12px 0;
      opacity: 0.7;
    }

    /* Joystick */
    #joystick-wrapper {
      margin-top: 4px;
    }

    #joystick-base {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      position: relative;
      background:
        radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3), transparent 60%),
        radial-gradient(circle at 70% 70%, rgba(0, 0, 0, 0.95), #05050c);
      border: 1px solid rgba(190, 220, 255, 0.7);
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.95),
        0 0 0 1px rgba(0, 0, 0, 1);
      touch-action: none;
      cursor: grab;
    }

    #joystick-base::before {
      content: "";
      position: absolute;
      inset: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 70%;
      border-radius: 50%;
      border: 1px dashed rgba(255, 255, 255, 0.24);
    }

    #joystick-handle {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background:
        radial-gradient(circle at 30% 20%, #ffffff, #d5e1ff 30%, #5b8cff 65%, #ff6fb1 100%);
      box-shadow:
        0 12px 24px rgba(0, 0, 0, 1),
        0 0 0 1px rgba(0, 0, 0, 1);
      border: 1px solid rgba(255, 255, 255, 0.8);
      pointer-events: none;
    }

    .joystick-caption {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
      max-width: 230px;
    }

    /* Click marker */
    #click-marker {
      position: absolute;
      width: 11px;
      height: 11px;
      border-radius: 50%;
      border: 2px solid #ff6fb1;
      background: rgba(255, 111, 177, 0.35);
      transform: translate(-50%, -50%);
      pointer-events: none;
      display: none;
      box-shadow: 0 0 12px rgba(255, 111, 177, 0.9);
      animation: ping 0.9s ease-out;
    }

    @keyframes ping {
      0% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0.0;
      }

      30% {
        transform: translate(-50%, -50%) scale(1.1);
        opacity: 1.0;
      }

      100% {
        transform: translate(-50%, -50%) scale(0.9);
        opacity: 0.3;
      }
    }

    @media (max-width: 900px) {
      .split {
        flex-direction: column;
      }

      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .hud {
        justify-content: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="app-header">
    <div>
      <h1>AI CAR STUDIO</h1>
      <p class="subtitle">
        Mini AI car playground ‚Äì camera ¬∑ data ¬∑ training ¬∑ deploy, all in one cockpit.
      </p>
    </div>
    <div>
      <div class="hud">
        <div class="hud-chip">
          <span id="hud-camera-dot" class="hud-dot"></span>
          <span class="hud-label">CAM</span>
          <span id="hud-camera-text">OFF</span>
        </div>
        <div class="hud-chip">
          <span class="hud-label">FPS</span>
          <span id="hud-fps">--</span>
        </div>
        <div class="hud-chip">
          <span class="hud-label">MOTOR</span>
          <span id="hud-motor">--</span>
        </div>
        <span class="badge">Raspberry Pi ¬∑ v2</span>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="file">
      <span class="tab-icon">üìÇ</span> File
    </button>
    <button class="tab-btn" data-tab="image">
      <span class="tab-icon">üì∑</span> Image
    </button>
    <button class="tab-btn" data-tab="train">
      <span class="tab-icon">üìà</span> Train
    </button>
    <button class="tab-btn" data-tab="deploy">
      <span class="tab-icon">ü§ñ</span> Deploy
    </button>
  </div>

  <!-- FILE TAB -->
  <div id="tab-file" class="tab-content active">
    <div class="split">
      <div class="left-col">
        <h2>File Manager</h2>
        <div class="row">
          <label>Path:
            <input id="fs-path" type="text" value=".">
          </label>
          <button onclick="fsList()">List</button>
        </div>
        <div class="row">
          <button onclick="fsNewFile()">New File</button>
          <button onclick="fsNewDir()">New Folder</button>
          <button onclick="fsDelete()">Delete Selected</button>
        </div>
        <div class="row">
          <span id="fs-selected" class="pill">
            <span class="pill-dot"></span> selected: none
          </span>
        </div>
        <div class="fs-list" id="fs-list"></div>
      </div>
      <div class="right-col">
        <h2>Editor</h2>
        <div class="row">
          <span id="fs-edit-path" class="pill">
            <span class="pill-dot"></span> no file
          </span>
          <button class="primary" onclick="fsSave()">Save</button>
        </div>
        <textarea id="fs-editor" placeholder="Open a file from the list to edit it here"></textarea>
      </div>
    </div>
  </div>

  <!-- IMAGE TAB -->
  <div id="tab-image" class="tab-content">
    <h2>Image & Data</h2>
    <div class="split">
      <div class="left-col">
        <h3>Camera</h3>
        <div class="row">
          <button class="primary" onclick="startCamera()">Start Camera</button>
          <button onclick="stopCamera()">Stop</button>
          <button onclick="snapshot()">Snapshot</button>
          <span id="cam-status" class="pill">
            <span class="pill-dot pill-bad"></span> Camera: unknown
          </span>
        </div>
        <div class="row">
          <label><input id="vflip" type="checkbox" onchange="updateProc()">V Flip</label>
          <label><input id="hflip" type="checkbox" onchange="updateProc()">H Flip</label>
          <label><input id="gray" type="checkbox" onchange="updateProc()">Gray</label>
          <label>Mode:
            <select id="proc-mode" onchange="updateProc()">
              <option value="raw">raw</option>
              <option value="gray">gray</option>
              <option value="edges">edges</option>
            </select>
          </label>
          <label>Gamma:
            <input id="gamma" type="number" step="0.1" value="1.0" min="0.5" max="2.0" onchange="updateProc()">
          </label>
        </div>

        <div class="video-frame">
          <img id="video" src="" alt="Camera stream (click to label)">
          <div class="video-overlay-corners">
            <div class="video-corner tl"></div>
            <div class="video-corner tr"></div>
            <div class="video-corner bl"></div>
            <div class="video-corner br"></div>
          </div>
          <div id="click-marker"></div>
        </div>

        <p style="font-size:12px;margin-top:6px;">
          Click on the image to save a labeled frame (x,y) into the current dataset.
          <br>
          <span id="last-label" class="pill">
            <span class="pill-dot"></span> last label: none
          </span>
        </p>
      </div>

      <div class="right-col">
        <h3>Datasets & Manual Control</h3>
        <div class="row">
          <label>Dataset:
            <select id="dataset-select"></select>
          </label>
          <button onclick="refreshDatasets()">Refresh</button>
        </div>
        <div class="row">
          <input id="dataset-new" type="text" placeholder="new dataset name">
          <button onclick="createDataset()">Create/Select</button>
          <span id="dataset-current" class="pill">
            <span class="pill-dot"></span> current: ?
          </span>
        </div>
        <pre id="dataset-summary" style="margin-top:6px;font-size:11px;max-height:120px;overflow:auto;"></pre>

        <hr class="soft">

        <h4>Joystick Drive</h4>
        <div class="row">
          <div id="joystick-wrapper">
            <div id="joystick-base">
              <div id="joystick-handle"></div>
            </div>
            <div class="joystick-caption">
              Drag inside the circle to drive.
              <br>Up/down = forward/back, left/right = turn.
            </div>
          </div>
          <div>
            <div class="row">
              <label>Left:
                <input id="left" type="number" step="0.1" value="0.0" min="-1" max="1">
              </label>
            </div>
            <div class="row">
              <label>Right:
                <input id="right" type="number" step="0.1" value="0.0" min="-1" max="1">
              </label>
            </div>
            <div class="row">
              <label>Speed gain:
                <input id="joy-speed" type="number" step="0.1" value="0.4" min="0" max="1">
              </label>
              <label>Steering gain:
                <input id="joy-steer" type="number" step="0.1" value="0.6" min="0" max="1">
              </label>
            </div>
            <div class="row">
              <button onclick="sendMotors()">Apply</button>
              <button onclick="stopMotors()">Stop</button>
            </div>
          </div>
        </div>

        <hr class="soft">

        <h4>Logging</h4>
        <div class="row">
          <label>Log rate (Hz):
            <input id="log-rate" type="number" step="0.5" value="5">
          </label>
          <label>Tag:
            <input id="log-tag" type="text" value="auto">
          </label>
        </div>
        <div class="row">
          <button onclick="startLogging()">Start Logging</button>
          <button onclick="stopLogging()">Stop Logging</button>
          <span id="log-status" class="pill">
            <span class="pill-dot"></span> logging: off
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- TRAIN TAB -->
  <div id="tab-train" class="tab-content">
    <h2>Train</h2>
    <p style="font-size:13px;">
      Currently this is a stub trainer that simulates training. Later we plug in your tiny CNN for (x,y) regression.
    </p>
    <div class="row">
      <label>Dataset:
        <select id="train-dataset"></select>
      </label>
      <button onclick="refreshTrainDatasets()">Refresh</button>
    </div>
    <div class="row">
      <label>Epochs:
        <input id="train-epochs" type="number" value="10" min="1">
      </label>
      <label>Learning rate:
        <input id="train-lr" type="text" value="0.001">
      </label>
      <label>Batch size:
        <input id="train-batch" type="number" value="32" min="1">
      </label>
      <button class="primary" onclick="startTrain()">Start Training</button>
    </div>
    <pre id="train-status"></pre>
    <pre id="train-dataset-summary" style="margin-top:6px;font-size:11px;max-height:120px;overflow:auto;"></pre>
  </div>

  <!-- DEPLOY TAB -->
  <div id="tab-deploy" class="tab-content">
    <h2>Deploy</h2>
    <div class="row">
      <button class="primary" onclick="startAutopilot()">Start Autopilot</button>
      <button onclick="stopAutopilot()">Stop</button>
      <button onclick="pollDeployStatus()">Refresh Status</button>
    </div>

    <div class="row">
      <label>Throttle gain:
        <input id="deploy-throttle" type="number" step="0.1" value="1.0">
      </label>
      <label>Steering gain:
        <input id="deploy-steering" type="number" step="0.1" value="1.0">
      </label>
      <label>Expo:
        <input id="deploy-expo" type="number" step="0.1" value="1.0">
      </label>
      <label>
        <input id="deploy-drive" type="checkbox"> Drive motors
      </label>
      <button onclick="updateDeployGains()">Apply</button>
    </div>

    <pre id="deploy-status"></pre>
  </div>

  <script>
    // ---------- Tabs ----------
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabContents = document.querySelectorAll(".tab-content");

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.toggle("active", b === btn));
        tabContents.forEach(c => c.classList.toggle("active", c.id === "tab-" + tab));
      });
    });

    // ---------- File tab ----------
    let fsSelectedPath = null;

    async function fsList() {
      const path = document.getElementById("fs-path").value;
      const res = await fetch("/api/fs/list?path=" + encodeURIComponent(path));
      const data = await res.json();
      const list = document.getElementById("fs-list");
      list.innerHTML = "";
      if (!data.ok) {
        list.textContent = "Error: " + data.error;
        return;
      }
      const entries = data.data.entries || [];
      entries.forEach(e => {
        const div = document.createElement("div");
        div.className = "fs-entry";
        div.onclick = () => fsSelect(path, e);
        const left = document.createElement("span");
        left.textContent = (e.is_dir ? "üìÅ " : "üìÑ ") + e.name;
        const right = document.createElement("span");
        right.textContent = e.size != null ? e.size + " B" : "";
        div.appendChild(left);
        div.appendChild(right);
        list.appendChild(div);
      });
    }

    function fsSelect(curPath, entry) {
      let full = curPath;
      if (full === ".") full = "";
      const rel = (full ? full + "/" : "") + entry.name;
      fsSelectedPath = rel;
      document.getElementById("fs-selected").innerHTML =
        '<span class="pill-dot pill-ok"></span> selected: ' + rel;
      if (!entry.is_dir) fsOpen(rel);
    }

    async function fsOpen(path) {
      const res = await fetch("/api/fs/read?path=" + encodeURIComponent(path));
      const data = await res.json();
      if (!data.ok) { alert("Read error: " + data.error); return; }
      document.getElementById("fs-edit-path").innerHTML =
        '<span class="pill-dot pill-ok"></span> ' + data.data.path;
      document.getElementById("fs-editor").value = data.data.content;
    }

    async function fsSave() {
      const pathText = document.getElementById("fs-edit-path").textContent;
      const path = pathText.replace(/^.*?\s/, "");
      if (!path || path === "no file") { alert("No file selected"); return; }
      const content = document.getElementById("fs-editor").value;
      const res = await fetch("/api/fs/write", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path, content })
      });
      const data = await res.json();
      if (!data.ok) alert("Save error: " + data.error);
      else alert("Saved: " + path);
    }

    async function fsNewFile() {
      const path = prompt("New file path (relative to FS root):");
      if (!path) return;
      const res = await fetch("/api/fs/write", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path, content: "" })
      });
      const data = await res.json();
      if (!data.ok) alert("Error: " + data.error);
      fsList();
    }

    async function fsNewDir() {
      const path = prompt("New folder path (relative to FS root):");
      if (!path) return;
      const res = await fetch("/api/fs/mkdir", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path })
      });
      const data = await res.json();
      if (!data.ok) alert("Error: " + data.error);
      fsList();
    }

    async function fsDelete() {
      if (!fsSelectedPath) { alert("No file/folder selected"); return; }
      if (!confirm("Delete " + fsSelectedPath + " (non-recursive)?")) return;
      const res = await fetch("/api/fs/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path: fsSelectedPath })
      });
      const data = await res.json();
      if (!data.ok) alert("Error: " + data.error);
      fsSelectedPath = null;
      document.getElementById("fs-selected").innerHTML =
        '<span class="pill-dot"></span> selected: none';
      fsList();
    }

    // ---------- Image tab: camera ----------
    async function startCamera() {
      const res = await fetch("/api/camera/start", { method: "POST" });
      const data = await res.json();
      if (data.ok) {
        document.getElementById("cam-status").innerHTML =
          '<span class="pill-dot pill-ok"></span> Camera: ON (' + (data.data.backend || "unknown") + ')';
        document.getElementById("video").src = "/api/video?ts=" + Date.now();

        document.getElementById("hud-camera-dot").classList.add("ok");
        document.getElementById("hud-camera-text").textContent = data.data.backend || "ON";
      } else {
        alert("Failed to start camera: " + data.error);
      }
    }

    async function stopCamera() {
      const res = await fetch("/api/camera/stop", { method: "POST" });
      const data = await res.json();
      if (data.ok) {
        document.getElementById("cam-status").innerHTML =
          '<span class="pill-dot pill-bad"></span> Camera: OFF';
        document.getElementById("video").src = "";
        document.getElementById("hud-camera-dot").classList.remove("ok");
        document.getElementById("hud-camera-text").textContent = "OFF";
      }
    }

    async function snapshot() {
      const img = document.getElementById("video");
      img.src = "/api/camera/frame?ts=" + Date.now();
    }

    async function updateProc() {
      const body = {
        vflip: document.getElementById("vflip").checked,
        hflip: document.getElementById("hflip").checked,
        gray: document.getElementById("gray").checked,
        mode: document.getElementById("proc-mode").value,
        gamma: parseFloat(document.getElementById("gamma").value || "1.0"),
      };
      await fetch("/api/camera/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
    }

    document.getElementById("video").addEventListener("click", async (e) => {
      const img = e.target;
      if (!img.src) return;
      const rect = img.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const marker = document.getElementById("click-marker");
      const px = (x / rect.width) * 100;
      const py = (y / rect.height) * 100;
      marker.style.left = px + "%";
      marker.style.top = py + "%";
      marker.style.display = "block";

      const body = {
        x, y,
        image_width: rect.width,
        image_height: rect.height,
        tag: "click"
      };
      const res = await fetch("/api/data/label_click", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Label save error: " + data.error);
      } else {
        const X = data.data.X;
        const Y = data.data.Y;
        document.getElementById("last-label").innerHTML =
          '<span class="pill-dot pill-ok"></span> last label: X=' + X + ', Y=' + Y;
      }
    });

    // ---------- Datasets & logging ----------
    async function refreshDatasets() {
      const res = await fetch("/api/datasets");
      const data = await res.json();
      if (!data.ok) return;
      const sel = document.getElementById("dataset-select");
      sel.innerHTML = "";
      (data.data.datasets || []).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        if (name === data.data.current) opt.selected = true;
        sel.appendChild(opt);
      });
      const current = data.data.current;
      document.getElementById("dataset-current").innerHTML =
        '<span class="pill-dot"></span> current: ' + current;
      loadDatasetSummary(current);
    }

    async function createDataset() {
      const input = document.getElementById("dataset-new");
      const name = input.value.trim() || document.getElementById("dataset-select").value;
      if (!name) { alert("Enter a dataset name or select one"); return; }
      const res = await fetch("/api/datasets/select", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });
      const data = await res.json();
      if (!data.ok) { alert("Error: " + data.error); return; }
      input.value = "";
      refreshDatasets();
      refreshTrainDatasets();
    }

    function sendMotorsValues(left, right, force = false) {
      const now = performance.now();
      const minInterval = 1000 / JOY_MAX_HZ;

      // Throttle joystick updates unless forced (e.g. from "Apply" button or stop)
      if (!force && (now - lastJoySend) < minInterval) {
        return;
      }
      lastJoySend = now;

      // Fire-and-forget; no await so UI doesn't stall
      fetch("/api/motors/openloop", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ left, right })
      }).catch(() => { /* ignore network errors here */ });
    }

    function sendMotors() {
      const left = parseFloat(document.getElementById("left").value || "0");
      const right = parseFloat(document.getElementById("right").value || "0");
      // Manual apply: always force (no throttling)
      sendMotorsValues(left, right, true);
    }


    async function stopMotors() {
      await fetch("/api/motors/stop", { method: "POST" });
      document.getElementById("left").value = "0.0";
      document.getElementById("right").value = "0.0";
      resetJoystick();
      lastJoySend = 0;
    }


    async function startLogging() {
      const rate_hz = parseFloat(document.getElementById("log-rate").value);
      const tag = document.getElementById("log-tag").value;
      const res = await fetch("/api/log/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rate_hz, tag })
      });
      const data = await res.json();
      if (data.ok) {
        const d = data.data || {};
        document.getElementById("log-status").innerHTML =
          '<span class="pill-dot pill-ok"></span> logging: on (' +
          (d.rate_hz ?? rate_hz) + ' Hz, ' + (d.tag ?? tag) + ')';
      } else {
        alert("Log start error: " + data.error);
      }
    }

    async function stopLogging() {
      await fetch("/api/log/stop", { method: "POST" });
      document.getElementById("log-status").innerHTML =
        '<span class="pill-dot"></span> logging: off';
    }

    // ---------- Joystick config ----------
    const JOY_DEADZONE = 0.15;   // radius in [0..1] below which we treat as "center"
    const JOY_MAX_HZ = 20;     // max updates per second to /api/motors/openloop
    let lastJoySend = 0;         // ms timestamp of last joystick send

    // ---------- Joystick ----------
    let joystickActive = false;

    function setupJoystick() {
      const base = document.getElementById("joystick-base");
      const handle = document.getElementById("joystick-handle");

      base.addEventListener("pointerdown", e => {
        joystickActive = true;
        base.setPointerCapture(e.pointerId);
        updateJoystick(e, base, handle);
      });

      base.addEventListener("pointermove", e => {
        if (!joystickActive) return;
        updateJoystick(e, base, handle);
      });

      base.addEventListener("pointerup", e => {
        joystickActive = false;
        base.releasePointerCapture(e.pointerId);
        // Immediate local reset
        resetJoystick();
        document.getElementById("left").value = "0.0";
        document.getElementById("right").value = "0.0";
        lastJoySend = 0;
        // Hard stop: force one final stop command
        sendMotorsValues(0.0, 0.0, true);
      });

      base.addEventListener("pointercancel", () => {
        joystickActive = false;
        resetJoystick();
        document.getElementById("left").value = "0.0";
        document.getElementById("right").value = "0.0";
        lastJoySend = 0;
        sendMotorsValues(0.0, 0.0, true);
      });
    }

    function resetJoystick() {
      const handle = document.getElementById("joystick-handle");
      handle.style.left = "50%";
      handle.style.top = "50%";
    }

    // NOTE: not async anymore
    function updateJoystick(e, base, handle) {
      const rect = base.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;

      let dx = e.clientX - cx;
      let dy = e.clientY - cy;

      const maxR = rect.width / 2;
      const dist = Math.sqrt(dx * dx + dy * dy);

      if (dist > maxR) {
        dx *= maxR / dist;
        dy *= maxR / dist;
      }

      const nx = dx / maxR;   // [-1,1]
      const ny = dy / maxR;   // [-1,1]
      const mag = Math.sqrt(nx * nx + ny * ny);

      // --- DEADZONE ---
      if (mag < JOY_DEADZONE) {
        // Snap handle to center and stop
        resetJoystick();
        document.getElementById("left").value = "0.00";
        document.getElementById("right").value = "0.00";
        sendMotorsValues(0.0, 0.0, true);
        return;
      }

      // Update handle position visually
      handle.style.left = (50 + (nx * 50)) + "%";
      handle.style.top = (50 + (ny * 50)) + "%";

      const speedGain = parseFloat(document.getElementById("joy-speed").value || "1.0");
      const steerGain = parseFloat(document.getElementById("joy-steer").value || "1.0");

      const throttleRaw = -ny; // up = forward
      const steeringRaw = -nx;  // flip sign here if left/right is reversed physically

      const throttle = throttleRaw * speedGain;
      const steering = steeringRaw * steerGain;

      let left = throttle - steering;
      let right = throttle + steering;

      const maxVal = Math.max(1, Math.max(Math.abs(left), Math.abs(right)));
      left /= maxVal;
      right /= maxVal;

      document.getElementById("left").value = left.toFixed(2);
      document.getElementById("right").value = right.toFixed(2);

      // Joystick path: throttled, not forced
      sendMotorsValues(left, right, false);
    }


    // ---------- Dataset summaries ----------
    async function loadDatasetSummary(name) {
      if (!name) return;
      const res = await fetch("/api/datasets/summary?name=" + encodeURIComponent(name));
      const data = await res.json();
      const el = document.getElementById("dataset-summary");
      if (!data.ok) {
        el.textContent = "Error: " + data.error;
        return;
      }
      el.textContent = JSON.stringify(data.data, null, 2);
    }

    async function loadTrainDatasetSummary(name) {
      if (!name) return;
      const res = await fetch("/api/datasets/summary?name=" + encodeURIComponent(name));
      const data = await res.json();
      const el = document.getElementById("train-dataset-summary");
      if (!data.ok) {
        el.textContent = "Error: " + data.error;
        return;
      }
      el.textContent = JSON.stringify(data.data, null, 2);
    }

    // ---------- Train tab ----------
    async function refreshTrainDatasets() {
      const res = await fetch("/api/datasets");
      const data = await res.json();
      if (!data.ok) return;
      const sel = document.getElementById("train-dataset");
      sel.innerHTML = "";
      (data.data.datasets || []).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        if (name === data.data.current) opt.selected = true;
        sel.appendChild(opt);
      });

      const current = sel.value || data.data.current;
      loadTrainDatasetSummary(current);
      sel.onchange = () => loadTrainDatasetSummary(sel.value);
    }

    async function startTrain() {
      const dataset = document.getElementById("train-dataset").value;
      const epochs = parseInt(document.getElementById("train-epochs").value || "10", 10);
      const learning_rate = parseFloat(document.getElementById("train-lr").value || "0.001");
      const batch_size = parseInt(document.getElementById("train-batch").value || "32", 10);
      const res = await fetch("/api/train/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dataset, epochs, learning_rate, batch_size })
      });
      const data = await res.json();
      if (!data.ok) { alert("Train start error: " + data.error); return; }
      pollTrainStatus();
    }

    async function pollTrainStatus() {
      const res = await fetch("/api/train/status");
      const data = await res.json();
      const el = document.getElementById("train-status");
      if (!data.ok) {
        el.textContent = "Error: " + data.error;
        return;
      }
      el.textContent = JSON.stringify(data.data, null, 2);
      if (data.data.running) {
        setTimeout(pollTrainStatus, 500);
      }
    }

    // ---------- Deploy tab ----------
    async function startAutopilot() {
      const res = await fetch("/api/deploy/start", { method: "POST" });
      const data = await res.json();
      if (!data.ok) alert("Error: " + data.error);
      pollDeployStatus();
    }

    async function stopAutopilot() {
      const res = await fetch("/api/deploy/stop", { method: "POST" });
      const data = await res.json();
      if (!data.ok) alert("Error: " + data.error);
      pollDeployStatus();
    }

    async function updateDeployGains() {
      const throttle_gain = parseFloat(document.getElementById("deploy-throttle").value || "1.0");
      const steering_gain = parseFloat(document.getElementById("deploy-steering").value || "1.0");
      const expo = parseFloat(document.getElementById("deploy-expo").value || "1.0");
      const drive_motors = document.getElementById("deploy-drive").checked;

      const res = await fetch("/api/deploy/gains", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ throttle_gain, steering_gain, expo, drive_motors })
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Update gains error: " + data.error);
        return;
      }
      pollDeployStatus();
    }

    async function pollDeployStatus() {
      const res = await fetch("/api/deploy/status");
      const data = await res.json();
      const el = document.getElementById("deploy-status");
      if (!data.ok) {
        el.textContent = "Error: " + data.error;
        return;
      }
      el.textContent = JSON.stringify(data.data, null, 2);

      const g = data.data.gains || {};
      document.getElementById("deploy-throttle").value = g.throttle_gain ?? 1.0;
      document.getElementById("deploy-steering").value = g.steering_gain ?? 1.0;
      document.getElementById("deploy-expo").value = g.expo ?? 1.0;
      document.getElementById("deploy-drive").checked = !!data.data.drive_motors;
    }

    // ---------- Bootstrap / Health ----------
    async function bootstrap() {
      fsList();
      refreshDatasets();
      refreshTrainDatasets();
      setupJoystick();

      const res = await fetch("/api/health");
      const data = await res.json();
      if (data.ok) {
        const h = data.data;
        document.getElementById("hud-motor").textContent = h.motor_backend || "--";
        if (typeof h.camera_fps === "number") {
          document.getElementById("hud-fps").textContent = h.camera_fps.toFixed(1);
        }
        if (h.camera_on) {
          document.getElementById("cam-status").innerHTML =
            '<span class="pill-dot pill-ok"></span> Camera: ON (' + h.camera_backend + ')';
          document.getElementById("video").src = "/api/video?ts=" + Date.now();
          document.getElementById("hud-camera-dot").classList.add("ok");
          document.getElementById("hud-camera-text").textContent = h.camera_backend || "ON";
        }
      }
    }

    bootstrap();
  </script>
</body>

</html>