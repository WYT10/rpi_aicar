<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>AI Car Studio</title>
  <style>
    :root {
      --bg: #050509;
      --card: #141420;
      --card-border: #2b2b3a;
      --accent: #4f7dff;
      --accent-soft: rgba(79, 125, 255, 0.15);
      --accent-2: #ff6fb1;
      --text-main: #f5f5ff;
      --text-soft: #9ca3c7;
      --pill-bg: rgba(255, 255, 255, 0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      padding: 16px;
      margin: 0;
      min-height: 100vh;
      color: var(--text-main);
      background:
        radial-gradient(circle at top left, #26245f 0, transparent 55%),
        radial-gradient(circle at bottom right, #43185c 0, transparent 55%),
        var(--bg);
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 24px;
      letter-spacing: 0.03em;
    }

    h2 {
      margin-top: 0;
      font-size: 18px;
    }

    h3 {
      margin-top: 0;
      font-size: 16px;
    }

    h4 {
      margin-top: 0;
      font-size: 14px;
    }

    p {
      color: var(--text-soft);
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.3);
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
    }

    .tab-btn {
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-soft);
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s all ease;
    }

    .tab-btn::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: transparent;
    }

    .tab-btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--text-main);
    }

    .tab-btn.active::before {
      background: var(--accent);
    }

    .tab-content {
      display: none;
      border-radius: 16px;
      padding: 14px 14px 18px 14px;
      background:
        linear-gradient(135deg, rgba(255, 255, 255, 0.04), transparent),
        var(--card);
      border: 1px solid var(--card-border);
      box-shadow:
        0 20px 40px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.02);
      margin-bottom: 12px;
    }

    .tab-content.active {
      display: block;
    }

    button {
      margin: 3px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-main);
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s all ease;
    }

    button:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.18);
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-color: transparent;
      color: #fff;
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.03),
        0 12px 24px rgba(0, 0, 0, 0.7);
    }

    button.primary:hover {
      filter: brightness(1.08);
    }

    input[type="number"],
    input[type="text"],
    select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(8, 8, 20, 0.8);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      min-width: 60px;
    }

    input[type="text"] {
      width: 160px;
    }

    input[type="checkbox"] {
      margin-right: 4px;
    }

    select {
      min-width: 120px;
    }

    label {
      font-size: 13px;
      color: var(--text-soft);
    }

    #video {
      border-radius: 12px;
      background: #000;
      /* Fixed size to match model input (224x224) */
      width: 224px;
      height: 224px;
      object-fit: cover;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.8);
      cursor: crosshair;
    }

    pre,
    textarea {
      width: 100%;
      box-sizing: border-box;
      background: #050510;
      color: var(--text-main);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 8px;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    textarea {
      min-height: 200px;
      resize: vertical;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .fs-list {
      max-height: 260px;
      overflow-y: auto;
      border-radius: 10px;
      padding: 4px;
      background: #05050c;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .fs-entry {
      display: flex;
      justify-content: space-between;
      padding: 3px 6px;
      cursor: pointer;
      font-size: 13px;
      border-radius: 6px;
      color: var(--text-soft);
    }

    .fs-entry:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-main);
    }

    .fs-entry.selected {
      background: var(--accent-soft);
      border: 1px solid var(--accent);
      color: var(--text-main);
    }

    .fs-breadcrumb {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow-x: auto;
    }

    .fs-crumb {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .fs-crumb:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-main);
    }

    .fs-crumb-sep {
      opacity: 0.4;
      margin: 0 4px;
    }

    #fs-preview-container {
      margin-top: 8px;
      border-radius: 10px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: none;
    }

    #fs-preview-inner {
      max-height: 260px;
      overflow: auto;
    }

    #fs-preview-img {
      max-width: 100%;
      max-height: 240px;
      display: block;
      border-radius: 8px;
    }

    #fs-preview-info {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      font-size: 11px;
      background: var(--pill-bg);
      color: var(--text-soft);
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #9ca3ff;
    }

    .pill-ok .pill-dot {
      background: #4ade80;
    }

    .pill-bad .pill-dot {
      background: #f97373;
    }

    .split {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }

    .left-col,
    .right-col {
      flex: 1 1 0;
      min-width: 0;
    }

    hr.soft {
      border: none;
      border-top: 1px dashed rgba(255, 255, 255, 0.12);
      margin: 10px 0;
    }

    /* Joystick */
    #joystick-wrapper {
      margin-top: 4px;
    }

    #joystick-base {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      position: relative;
      background:
        radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.2), transparent 60%),
        radial-gradient(circle at 70% 70%, rgba(0, 0, 0, 0.9), #05050c);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(0, 0, 0, 0.8);
      touch-action: none;
      cursor: grab;
    }

    #joystick-base::before {
      content: "";
      position: absolute;
      inset: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 70%;
      border-radius: 50%;
      border: 1px dashed rgba(255, 255, 255, 0.12);
    }

    #joystick-handle {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background:
        radial-gradient(circle at 30% 20%, #ffffff, #ccccff 30%, #4f7dff 70%);
      box-shadow:
        0 10px 20px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.7);
      pointer-events: none;
    }

    .joystick-caption {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
      max-width: 220px;
    }

    #click-marker {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid #ff6fb1;
      background: rgba(255, 111, 177, 0.3);
      transform: translate(-50%, -50%);
      pointer-events: none;
      display: none;
    }

    @media (max-width: 900px) {
      .split {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="app-header">
    <div>
      <h1>AI Car Studio</h1>
      <p style="margin:0;font-size:13px;color:var(--text-soft);">
        Mini AI car playground â€“ camera, data, training, deploy â€“ all from the browser.
      </p>
    </div>
    <div>
      <span class="badge">Raspberry Pi â€¢ v2 UI</span>
      <span id="cam-fps" class="pill"><span class="pill-dot"></span> FPS: --</span>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="file">File</button>
    <button class="tab-btn" data-tab="image">Image</button>
    <button class="tab-btn" data-tab="train">Train</button>
    <button class="tab-btn" data-tab="deploy">Deploy</button>
  </div>

  <!-- FILE TAB -->
  <div id="tab-file" class="tab-content active">
    <div class="split">
      <div class="left-col">
        <h2>File Manager</h2>
        <div class="row">
          <label>Path:
            <input id="fs-path" type="text" value=".">
          </label>
          <button onclick="fsSetPath(document.getElementById('fs-path').value)">Go</button>
        </div>
        <div class="row">
          <div id="fs-breadcrumb" class="fs-breadcrumb"></div>
        </div>
        <div class="row">
          <button onclick="fsNewFile()">New File</button>
          <button onclick="fsNewDir()">New Folder</button>
          <button onclick="fsDelete()">Delete Selected</button>
        </div>
        <div class="row">
          <span id="fs-selected" class="pill">
            <span class="pill-dot"></span> selected: none
          </span>
        </div>
        <div id="fs-list" class="fs-list"></div>
      </div>
      <div class="right-col">
        <h2>Editor</h2>
        <div class="row">
          <span id="fs-edit-path" class="pill">
            <span class="pill-dot"></span> no file
          </span>
          <button class="primary" onclick="fsSave()">Save</button>
        </div>
        <textarea id="fs-editor" placeholder="Open a file from the list to edit it here"></textarea>

        <div id="fs-preview-container">
          <div class="row" style="margin-top:6px;margin-bottom:4px;">
            <span class="pill">
              <span class="pill-dot"></span> Image preview
            </span>
          </div>
          <div id="fs-preview-inner">
            <img id="fs-preview-img" alt="Preview">
            <div id="fs-preview-info"></div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- IMAGE TAB -->
  <div id="tab-image" class="tab-content">
    <h2>Image & Data</h2>
    <div class="split">
      <div class="left-col">
        <h3>Camera</h3>
        <div class="row">
          <button class="primary" onclick="startCamera()">Start Camera</button>
          <button onclick="stopCamera()">Stop</button>
          <button onclick="snapshot()">Snapshot</button>
          <span id="cam-status" class="pill">
            <span class="pill-dot pill-bad"></span> Camera: unknown
          </span>
        </div>
        <div class="row">
          <label>Cam FPS:
            <input id="cam-fps-input" type="number" min="1" max="60" step="1" style="width:70px;">
          </label>
          <button onclick="applyCameraConfig()">Apply Camera FPS</button>
          <span id="cam-config-status" class="pill">
            <span class="pill-dot"></span> cam cfg
          </span>
        </div>
        <div class="row">
          <label><input id="vflip" type="checkbox" onchange="updateProc()">V Flip</label>
          <label><input id="hflip" type="checkbox" onchange="updateProc()">H Flip</label>
          <label><input id="gray" type="checkbox" onchange="updateProc()">Gray</label>
          <label>Mode:
            <select id="proc-mode" onchange="updateProc()">
              <option value="raw">raw</option>
              <option value="gray">gray</option>
              <option value="edges">edges</option>
            </select>
          </label>
          <label>Gamma:
            <input id="gamma" type="number" step="0.1" value="1.0" min="0.5" max="2.0" onchange="updateProc()">
          </label>
        </div>

        <div style="position:relative; display:inline-block;">
          <img id="video" src="" alt="Camera stream (click to label)">
          <div id="click-marker"></div>
        </div>

        <div class="row" style="margin-top:6px;">
          <label style="font-size:12px;">
            <input id="ghost-toggle" type="checkbox" onchange="toggleGhostOverlay(this.checked)">
            Show AI ghost overlay
          </label>
        </div>


        <p style="font-size:12px;margin-top:6px;">
          Click on the image to save a labeled frame (x,y) into the current dataset.
          <br>
          <span id="last-label" class="pill">
            <span class="pill-dot"></span> last label: none
          </span>
        </p>
      </div>

      <div class="right-col">
        <h3>Datasets & Manual Control</h3>
        <div class="row">
          <label>Dataset:
            <select id="dataset-select"></select>
          </label>
          <button onclick="refreshDatasets()">Refresh</button>
        </div>
        <div class="row">
          <input id="dataset-new" type="text" placeholder="new dataset name">
          <button onclick="createDataset()">Create/Select</button>
          <span id="dataset-current" class="pill">
            <span class="pill-dot"></span> current: ?
          </span>
        </div>
        <pre id="dataset-summary" style="margin-top:6px;font-size:11px;max-height:120px;overflow:auto;"></pre>

        <hr class="soft">

        <h4>Joystick Drive</h4>
        <div class="row">
          <div id="joystick-wrapper">
            <div id="joystick-base">
              <div id="joystick-handle"></div>
            </div>
            <div class="joystick-caption">
              Drag inside the circle to drive.
              <br>Up = forward, left/right = turn. Forward-only motors.
            </div>
          </div>
          <div>
            <div class="row">
              <label>Left:
                <input id="left" type="number" step="0.1" value="0.0" min="0" max="1">
              </label>
            </div>
            <div class="row">
              <label>Right:
                <input id="right" type="number" step="0.1" value="0.0" min="0" max="1">
              </label>
            </div>
            <div class="row">
              <label>Speed gain:
                <input id="joy-speed" type="number" step="0.1" value="0.5" min="0" max="1">
              </label>
              <label>Steering gain:
                <input id="joy-steer" type="number" step="0.1" value="0.1" min="0" max="1">
              </label>
            </div>
            <div class="row">
              <label>Loop Hz:
                <input id="ctrl-hz" type="number" min="5" max="200" step="5" value="100" style="width:70px;">
              </label>
              <label>Î± (smooth):
                <input id="ctrl-alpha" type="number" min="0" max="1" step="0.05" value="0.35" style="width:70px;">
              </label>
            </div>
            <div class="row">
              <label>Left trim:
                <input id="ctrl-left-trim" type="number" min="0.5" max="1.5" step="0.02" value="1.00"
                  style="width:70px;">
              </label>
              <label>Right trim:
                <input id="ctrl-right-trim" type="number" min="0.5" max="1.5" step="0.02" value="1.00"
                  style="width:70px;">
              </label>
            </div>
            <div class="row">
              <label>Throttle expo:
                <input id="ctrl-expo" type="number" min="0.5" max="3.0" step="0.1" value="1.3" style="width:70px;">
              </label>
              <button onclick="applyControlParams()">Apply Control</button>
              <span id="ctrl-status" class="pill">
                <span class="pill-dot"></span> control cfg
              </span>
            </div>
            <div class="row">
              <button onclick="applyDirectMotors()">Apply (direct)</button>
              <button onclick="stopMotors()">Stop</button>
            </div>
          </div>
        </div>

        <hr class="soft">

        <h4>Logging</h4>
        <div class="row">
          <label>Log rate (Hz):
            <input id="log-rate" type="number" step="0.5" value="5">
          </label>
          <label>Tag:
            <input id="log-tag" type="text" value="auto">
          </label>
        </div>
        <div class="row">
          <button onclick="startLogging()">Start Logging</button>
          <button onclick="stopLogging()">Stop Logging</button>
          <span id="log-status" class="pill">
            <span class="pill-dot"></span> logging: off
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- TRAIN TAB -->
  <div id="tab-train" class="tab-content">
    <h2>Train</h2>
    <p style="font-size:13px;">
      End-to-end loop for your click-labelled dataset.<br>
      1) Collect images on the <b>Image</b> tab (filenames encode X/Y).<br>
      2) Choose a dataset & hyperparams here and start training.<br>
      3) Run <b>Validate</b> to see basic metrics, and <b>Test current frame</b> to check behaviour in real time.
    </p>

    <!-- Dataset + hyperparams -->
    <div class="row">
      <label>Dataset:
        <select id="train-dataset"></select>
      </label>
      <button onclick="refreshTrainDatasets()">Refresh</button>
    </div>
    <div class="row">
      <label>Epochs:
        <input id="train-epochs" type="number" value="10" min="1">
      </label>
      <label>Learning rate:
        <input id="train-lr" type="text" value="0.001">
      </label>
      <label>Batch size:
        <input id="train-batch" type="number" value="32" min="1">
      </label>
      <button class="primary" onclick="startTrain()">Start Training</button>
    </div>

    <!-- Training status -->
    <h4 style="margin-top:12px;">Training status</h4>
    <pre id="train-status" style="font-size:11px;max-height:140px;overflow:auto;"></pre>

    <!-- Dataset summary -->
    <h4 style="margin-top:12px;">Dataset summary</h4>
    <pre id="train-dataset-summary" style="font-size:11px;max-height:120px;overflow:auto;"></pre>

    <!-- Validation + real-time test -->
    <hr class="soft">

    <h4>Validate & real-time test</h4>
    <div class="row">
      <button onclick="validateDataset()">Validate on dataset</button>
      <button onclick="testModelOnCurrentFrame()">Test model on current frame</button>
      <span id="train-test-status" class="pill">
        <span class="pill-dot"></span> idle
      </span>
    </div>
    <div class="row" style="margin-top:6px;">
      <div style="flex:1; margin-right:8px;">
        <div style="font-size:11px;color:var(--text-soft);margin-bottom:4px;">Validation result</div>
        <pre id="train-validation" style="font-size:11px;max-height:120px;overflow:auto;"></pre>
      </div>
      <div style="flex:1; margin-left:8px;">
        <div style="font-size:11px;color:var(--text-soft);margin-bottom:4px;">Current-frame test</div>
        <pre id="train-test-output" style="font-size:11px;max-height:120px;overflow:auto;"></pre>
      </div>
    </div>
  </div>


  <!-- DEPLOY TAB -->
  <div id="tab-deploy" class="tab-content">
    <h2>Deploy / Autopilot</h2>
    <p style="font-size:13px;">
      This tab is about <b>online behaviour</b>:
      choose a model, test it on the live camera frame, then start the
      autopilot loop and tune gains.
    </p>

    <!-- Model selection row -->
    <div class="row">
      <label>Model:
        <select id="deploy-model"></select>
      </label>
      <button onclick="refreshModels()">Refresh models</button>
      <button onclick="convertSelectedModelToInt8()">Make INT8 copy</button>
      <span id="model-status" class="pill">
        <span class="pill-dot"></span> no model loaded
      </span>
    </div>


    <!-- Control row (autopilot + live test) -->
    <div class="row">
      <button class="primary" onclick="startAutopilot()">Start Autopilot</button>
      <button onclick="stopAutopilot()">Stop</button>
      <button onclick="pollDeployStatus()">Refresh Status</button>
      <button onclick="testModelOnCurrentFrame()">Test on current frame</button>
      <span id="deploy-test-status" class="pill">
        <span class="pill-dot"></span> idle
      </span>
    </div>

    <!-- Gains row -->
    <div class="row">
      <label>Throttle gain:
        <input id="deploy-throttle" type="number" step="0.1" value="1.0">
      </label>
      <label>Steering gain:
        <input id="deploy-steering" type="number" step="0.1" value="1.0">
      </label>
      <label>Expo:
        <input id="deploy-expo" type="number" step="0.1" value="1.0">
      </label>
      <label>
        <input id="deploy-drive" type="checkbox"> Drive motors
      </label>
    </div>

    <!-- Assist & safety row -->
    <div class="row">
      <label>Mode:
        <select id="deploy-mode">
          <option value="assist">Assist</option>
          <option value="auto">Auto</option>
        </select>
      </label>
      <label>Assist blend:
        <input id="deploy-assist" type="range" min="0" max="1" step="0.1" value="0.7"
          oninput="document.getElementById('deploy-assist-label').textContent = this.value">
      </label>
      <span id="deploy-assist-label" style="font-size:12px;color:var(--text-soft);">0.7</span>
      <label>
        <input id="deploy-reflex" type="checkbox" checked> Reflex safety
      </label>
      <label>Min brightness:
        <input id="deploy-min-brightness" type="number" step="1" value="18">
      </label>
      <button onclick="updateDeployGains()">Apply</button>
    </div>

    <pre id="deploy-status" style="margin-top:8px;"></pre>
  </div>


  <script>
    // =====================================================
    // AI CAR FRONTEND â€“ SECTION MAP
    // [A] Tabs + layout
    // [B] File manager
    // [C] Health poll (FPS)
    // [D] Camera & labeling
    // [E] Datasets
    // [F] Motors: manual & logging
    // [G] Motors: joystick
    // [H] Train
    // [I] Deploy
    // [J] Bootstrap
    // =====================================================

    // [A] Tabs + layout
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabContents = document.querySelectorAll(".tab-content");

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.toggle("active", b === btn));
        tabContents.forEach(c => c.classList.toggle("active", c.id === "tab-" + tab));
      });
    });

    // [B] File manager
    // [B] File manager
    let fsCurrentPath = ".";
    let fsSelection = new Set();
    let fsSelectedPath = null;
    let fsLastIndex = -1;

    function fsIsImage(path) {
      return /\.(png|jpg|jpeg|gif|bmp|webp)$/i.test(path || "");
    }

    function fsUpdateSelectedPill() {
      const pill = document.getElementById("fs-selected");
      if (!pill) return;
      const count = fsSelection.size;
      if (count === 0) {
        pill.innerHTML = '<span class="pill-dot"></span> selected: none';
      } else if (count === 1) {
        const only = Array.from(fsSelection)[0];
        pill.innerHTML =
          '<span class="pill-dot pill-ok"></span> selected: ' + only;
      } else {
        pill.innerHTML =
          '<span class="pill-dot pill-ok"></span> selected: ' +
          count + ' items';
      }
    }

    function fsRenderBreadcrumb(path) {
      const bc = document.getElementById("fs-breadcrumb");
      if (!bc) return;
      bc.innerHTML = "";

      const norm = (path && path !== ".") ? path : ".";
      const parts = norm.split("/").filter(p => p && p !== ".");

      // Root crumb
      const rootSpan = document.createElement("span");
      rootSpan.className = "fs-crumb";
      rootSpan.textContent = ".";
      rootSpan.onclick = () => fsSetPath(".");
      bc.appendChild(rootSpan);

      let accum = "";
      parts.forEach((p, idx) => {
        const sep = document.createElement("span");
        sep.className = "fs-crumb-sep";
        sep.textContent = "/";
        bc.appendChild(sep);

        accum = accum ? (accum + "/" + p) : p;
        const crumb = document.createElement("span");
        crumb.className = "fs-crumb";
        crumb.textContent = p;
        crumb.onclick = () => fsSetPath(accum);
        bc.appendChild(crumb);
      });
    }

    function fsRefreshSelectionClasses() {
      const list = document.getElementById("fs-list");
      if (!list) return;
      Array.from(list.children).forEach(div => {
        const p = div.dataset.path;
        if (p && fsSelection.has(p)) {
          div.classList.add("selected");
        } else {
          div.classList.remove("selected");
        }
      });
    }

    function fsSetPath(path) {
      fsCurrentPath = path && path !== "" ? path : ".";
      const input = document.getElementById("fs-path");
      if (input) input.value = fsCurrentPath;
      fsSelection.clear();
      fsSelectedPath = null;
      fsLastIndex = -1;
      fsUpdateSelectedPill();
      fsRenderBreadcrumb(fsCurrentPath);
      fsList();
    }

    async function fsList() {
      const path = fsCurrentPath;
      const res = await fetch("/api/fs/list?path=" + encodeURIComponent(path));
      const data = await res.json();
      const list = document.getElementById("fs-list");
      list.innerHTML = "";
      if (!data.ok) {
        list.textContent = "Error: " + data.error;
        return;
      }
      const entries = data.data.entries || [];
      entries.forEach((e, idx) => {
        let base = path;
        if (base === ".") base = "";
        const rel = (base ? base + "/" : "") + e.name;

        const div = document.createElement("div");
        div.className = "fs-entry";
        div.dataset.path = rel;
        div.dataset.index = String(idx);

        const left = document.createElement("span");
        left.textContent = (e.is_dir ? "ðŸ“ " : "ðŸ“„ ") + e.name;
        const right = document.createElement("span");
        right.textContent = e.size != null ? e.size + " B" : "";
        div.appendChild(left);
        div.appendChild(right);

        div.onclick = (evt) => fsHandleEntryClick(evt, path, e, idx, rel);
        list.appendChild(div);
      });

      fsRefreshSelectionClasses();
      fsRenderBreadcrumb(path);
    }

    function fsHandleEntryClick(evt, curPath, entry, index, rel) {
      // Single-click folder with no modifiers -> enter folder
      if (entry.is_dir && !evt.ctrlKey && !evt.metaKey && !evt.shiftKey) {
        fsSetPath(rel);
        return;
      }

      // Selection logic (like VS Code-ish)
      const list = document.getElementById("fs-list");
      const children = Array.from(list.children);

      if (evt.shiftKey && fsLastIndex >= 0 && fsLastIndex < children.length) {
        // Range select
        fsSelection.clear();
        const start = Math.min(fsLastIndex, index);
        const end = Math.max(fsLastIndex, index);
        for (let i = start; i <= end; i++) {
          const p = children[i].dataset.path;
          if (p) fsSelection.add(p);
        }
      } else if (evt.ctrlKey || evt.metaKey) {
        // Toggle add/remove
        if (fsSelection.has(rel)) fsSelection.delete(rel);
        else fsSelection.add(rel);
        fsLastIndex = index;
      } else {
        // Single selection
        fsSelection.clear();
        fsSelection.add(rel);
        fsLastIndex = index;
      }

      fsSelectedPath = rel;
      fsUpdateSelectedPill();
      fsRefreshSelectionClasses();

      // If it's a file and we didn't use modifiers: open it
      if (!entry.is_dir && !(evt.ctrlKey || evt.metaKey || evt.shiftKey)) {
        fsOpen(rel);
      }
    }

    async function fsOpen(path) {
      const res = await fetch("/api/fs/read?path=" + encodeURIComponent(path));
      const data = await res.json();
      if (!data.ok) {
        alert("Read error: " + data.error);
        return;
      }
      document.getElementById("fs-edit-path").innerHTML =
        '<span class="pill-dot pill-ok"></span> ' + data.data.path;
      document.getElementById("fs-editor").value = data.data.content || "";

      fsUpdatePreview(path);
    }

    function fsUpdatePreview(path) {
      const container = document.getElementById("fs-preview-container");
      const img = document.getElementById("fs-preview-img");
      const info = document.getElementById("fs-preview-info");
      if (!container || !img || !info) return;

      if (!fsIsImage(path)) {
        container.style.display = "none";
        img.src = "";
        info.textContent = "";
        return;
      }
      const url = "/api/fs/raw?path=" + encodeURIComponent(path) + "&ts=" + Date.now();
      img.src = url;
      container.style.display = "block";
      info.textContent = path;
    }

    async function fsSave() {
      const pill = document.getElementById("fs-edit-path");
      const text = pill.textContent || "";
      const parts = text.split(/\s+/);
      const path = parts.slice(1).join(" ").trim(); // after dot
      if (!path || path === "no file") {
        alert("No file selected");
        return;
      }
      const content = document.getElementById("fs-editor").value;
      const res = await fetch("/api/fs/write", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path, content })
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Save error: " + data.error);
      } else {
        alert("Saved: " + path);
      }
    }

    async function fsNewFile() {
      const path = prompt("New file path (relative to FS root):");
      if (!path) return;
      const res = await fetch("/api/fs/write", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path, content: "" })
      });
      const data = await res.json();
      if (!data.ok) alert("Error: " + data.error);
      fsList();
    }

    async function fsNewDir() {
      const path = prompt("New folder path (relative to FS root):");
      if (!path) return;
      const res = await fetch("/api/fs/mkdir", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path })
      });
      const data = await res.json();
      if (!data.ok) alert("Error: " + data.error);
      fsList();
    }

    async function fsDelete() {
      if (!fsSelection.size) {
        alert("No file/folder selected");
        return;
      }
      const items = Array.from(fsSelection);
      if (!confirm("Delete " + items.join(", ") + " (non-recursive)?")) return;

      for (const p of items) {
        const res = await fetch("/api/fs/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ path: p })
        });
        const data = await res.json();
        if (!data.ok) {
          alert("Error deleting " + p + ": " + data.error);
          break;
        }
      }

      fsSelection.clear();
      fsSelectedPath = null;
      fsUpdateSelectedPill();
      fsList();
    }

    // [C] Health poll (FPS)
    async function pollHealth() {
      try {
        const res = await fetch("/api/health");
        const data = await res.json();
        if (!data.ok) return;
        const fps = data.data.camera_fps || 0.0;
        document.getElementById("cam-fps").innerHTML =
          '<span class="pill-dot"></span> FPS: ' + fps.toFixed(1);
        const status = document.getElementById("cam-status");
        if (status) {
          const on = data.data.camera_on;
          const backend = data.data.camera_backend || "none";
          status.innerHTML =
            '<span class="pill-dot ' + (on ? 'pill-ok' : 'pill-bad') +
            '"></span> Camera: ' + (on ? 'ON' : 'OFF') + ' (' + backend + ')';
        }
      } catch (e) { }
    }
    setInterval(pollHealth, 1000);

    // [D] Camera & labeling
    async function startCamera() {
      const res = await fetch("/api/camera/start", { method: "POST" });
      const data = await res.json();
      if (!data.ok) {
        alert("Failed to start camera: " + data.error);
        return;
      }
      document.getElementById("cam-status").innerHTML =
        '<span class="pill-dot pill-ok"></span> Camera: ON (' +
        (data.data.backend || "unknown") + ')';
      document.getElementById("video").src = "/api/video?ts=" + Date.now();
    }

    async function stopCamera() {
      const res = await fetch("/api/camera/stop", { method: "POST" });
      const data = await res.json();
      if (!data.ok) return;
      document.getElementById("cam-status").innerHTML =
        '<span class="pill-dot pill-bad"></span> Camera: OFF';
      document.getElementById("video").src = "";
    }

    async function loadCameraConfig() {
      try {
        const res = await fetch("/api/camera/config");
        const data = await res.json();
        if (!data.ok) return;
        const cfg = data.data;
        document.getElementById("cam-fps-input").value = cfg.fps ?? 15;
        document.getElementById("cam-config-status").innerHTML =
          '<span class="pill-dot"></span> fps: ' + (cfg.fps ?? "--") +
          ', ' + (cfg.width ?? "?") + 'x' + (cfg.height ?? "?");
      } catch (e) { }
    }

    async function applyCameraConfig() {
      const fps = parseInt(document.getElementById("cam-fps-input").value || "0", 10);
      if (!fps || fps <= 0) {
        alert("Invalid FPS");
        return;
      }
      try {
        const res = await fetch("/api/camera/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fps })
        });
        const data = await res.json();
        if (!data.ok) {
          alert("Camera config error: " + data.error);
          return;
        }
        const cfg = data.data;
        document.getElementById("cam-config-status").innerHTML =
          '<span class="pill-dot pill-ok"></span> fps: ' + cfg.fps +
          ', ' + cfg.width + 'x' + cfg.height;
        if (cfg.camera_on) {
          document.getElementById("video").src = "/api/video?ts=" + Date.now();
        }
      } catch (e) {
        alert("Camera config error: " + e);
      }
    }

    async function snapshot() {
      document.getElementById("video").src = "/api/camera/frame?ts=" + Date.now();
    }

    async function updateProc() {
      const body = {
        vflip: document.getElementById("vflip").checked,
        hflip: document.getElementById("hflip").checked,
        gray: document.getElementById("gray").checked,
        mode: document.getElementById("proc-mode").value,
        gamma: parseFloat(document.getElementById("gamma").value || "1.0")
      };
      await fetch("/api/camera/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
    }

    document.getElementById("video").addEventListener("click", async (e) => {
      const img = e.target;
      if (!img.src) return;
      const rect = img.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const marker = document.getElementById("click-marker");
      marker.style.left = (x / rect.width) * 100 + "%";
      marker.style.top = (y / rect.height) * 100 + "%";
      marker.style.display = "block";

      const body = {
        x, y,
        image_width: rect.width,
        image_height: rect.height,
        tag: "click"
      };
      const res = await fetch("/api/data/label_click", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Label save error: " + data.error);
        return;
      }
      const X = data.data.X;
      const Y = data.data.Y;
      document.getElementById("last-label").innerHTML =
        '<span class="pill-dot pill-ok"></span> last label: X=' + X + ', Y=' + Y;
    });

    // [E] Datasets
    async function refreshDatasets() {
      const res = await fetch("/api/datasets");
      const data = await res.json();
      if (!data.ok) return;
      const sel = document.getElementById("dataset-select");
      sel.innerHTML = "";
      (data.data.datasets || []).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        if (name === data.data.current) opt.selected = true;
        sel.appendChild(opt);
      });
      const current = data.data.current;
      document.getElementById("dataset-current").innerHTML =
        '<span class="pill-dot"></span> current: ' + current;
      loadDatasetSummary(current);
    }

    async function createDataset() {
      const input = document.getElementById("dataset-new");
      const name = input.value.trim() || document.getElementById("dataset-select").value;
      if (!name) {
        alert("Enter a dataset name or select one");
        return;
      }
      const res = await fetch("/api/datasets/select", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Error: " + data.error);
        return;
      }
      input.value = "";
      refreshDatasets();
      refreshTrainDatasets();
    }

    async function loadDatasetSummary(name) {
      if (!name) return;
      const res = await fetch("/api/datasets/summary?name=" + encodeURIComponent(name));
      const data = await res.json();
      const el = document.getElementById("dataset-summary");
      if (!data.ok) {
        el.textContent = "Error: " + data.error;
        return;
      }
      el.textContent = JSON.stringify(data.data, null, 2);
    }

    // [F] Motors: manual & logging
    const JOY_DEADZONE = 0.1;
    let desiredLeft = 0.0;
    let desiredRight = 0.0;
    let lastSentLeft = 0.0;
    let lastSentRight = 0.0;
    let sendInFlight = false;

    function sendOpenloop(left, right) {
      desiredLeft = Math.max(0, Math.min(1, left));
      desiredRight = Math.max(0, Math.min(1, right));
    }

    async function sendMotorLoop() {
      const dl = Math.abs(desiredLeft - lastSentLeft);
      const dr = Math.abs(desiredRight - lastSentRight);
      if (dl < 0.01 && dr < 0.01) return;
      if (sendInFlight) return;
      sendInFlight = true;
      lastSentLeft = desiredLeft;
      lastSentRight = desiredRight;
      try {
        await fetch("/api/motors/openloop", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ left: desiredLeft, right: desiredRight })
        });
      } catch (e) {
      } finally {
        sendInFlight = false;
      }
    }
    setInterval(sendMotorLoop, 50); // 20 Hz

    async function applyDirectMotors() {
      const left = parseFloat(document.getElementById("left").value || "0");
      const right = parseFloat(document.getElementById("right").value || "0");
      sendOpenloop(left, right);
    }

    async function stopMotors() {
      sendOpenloop(0, 0);
      await fetch("/api/motors/stop", { method: "POST" });
      document.getElementById("left").value = "0.0";
      document.getElementById("right").value = "0.0";
      resetJoystick();
    }

    async function startLogging() {
      const rate = parseFloat(document.getElementById("log-rate").value || "5");
      const tag = document.getElementById("log-tag").value || "auto";
      const res = await fetch("/api/log/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rate_hz: rate, tag })
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Logging error: " + data.error);
        return;
      }
      document.getElementById("log-status").innerHTML =
        '<span class="pill-dot pill-ok"></span> logging: on @ ' + data.data.rate_hz + ' Hz';
    }

    async function stopLogging() {
      const res = await fetch("/api/log/stop", { method: "POST" });
      const data = await res.json();
      if (!data.ok) return;
      document.getElementById("log-status").innerHTML =
        '<span class="pill-dot"></span> logging: off';
    }

    async function loadControlParams() {
      try {
        const res = await fetch("/api/control/params");
        const data = await res.json();
        if (!data.ok) return;
        const p = data.data;
        document.getElementById("ctrl-hz").value = p.hz ?? 100;
        document.getElementById("ctrl-alpha").value = p.alpha ?? 0.35;
        document.getElementById("ctrl-left-trim").value = p.left_trim ?? 1.0;
        document.getElementById("ctrl-right-trim").value = p.right_trim ?? 1.0;
        document.getElementById("ctrl-expo").value = p.throttle_expo ?? 1.3;
        document.getElementById("ctrl-status").innerHTML =
          '<span class="pill-dot"></span> Hz ' + (p.hz ?? 0).toFixed(1) +
          ' â€¢ Î± ' + (p.alpha ?? 0).toFixed(2) +
          ' â€¢ L ' + (p.left_trim ?? 1).toFixed(2) +
          ' â€¢ R ' + (p.right_trim ?? 1).toFixed(2) +
          ' â€¢ expo ' + (p.throttle_expo ?? 1).toFixed(2);
      } catch (e) { }
    }

    async function applyControlParams() {
      const hz = parseFloat(document.getElementById("ctrl-hz").value || "100");
      const alpha = parseFloat(document.getElementById("ctrl-alpha").value || "0.35");
      const lt = parseFloat(document.getElementById("ctrl-left-trim").value || "1.0");
      const rt = parseFloat(document.getElementById("ctrl-right-trim").value || "1.0");
      const expo = parseFloat(document.getElementById("ctrl-expo").value || "1.3");
      const res = await fetch("/api/control/params", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          hz, alpha,
          left_trim: lt,
          right_trim: rt,
          throttle_expo: expo
        })
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Control config error: " + data.error);
        return;
      }
      const p = data.data;
      document.getElementById("ctrl-status").innerHTML =
        '<span class="pill-dot pill-ok"></span> Hz ' + (p.hz ?? 0).toFixed(1) +
        ' â€¢ Î± ' + (p.alpha ?? 0).toFixed(2) +
        ' â€¢ L ' + (p.left_trim ?? 1).toFixed(2) +
        ' â€¢ R ' + (p.right_trim ?? 1).toFixed(2) +
        ' â€¢ expo ' + (p.throttle_expo ?? 1).toFixed(2);
    }

    // [G] Motors: joystick
    let joystickActive = false;

    function resetJoystick() {
      const base = document.getElementById("joystick-base");
      const handle = document.getElementById("joystick-handle");
      if (!base || !handle) return;
      handle.style.left = "50%";
      handle.style.top = "50%";
      joystickActive = false;
    }

    function hardStopJoystick() {
      resetJoystick();
      document.getElementById("left").value = "0.0";
      document.getElementById("right").value = "0.0";
      sendOpenloop(0, 0);
    }

    function setupJoystick() {
      const base = document.getElementById("joystick-base");
      const handle = document.getElementById("joystick-handle");
      if (!base || !handle) return;

      base.addEventListener("pointerdown", (e) => {
        joystickActive = true;
        base.setPointerCapture(e.pointerId);
        updateJoystick(e, base, handle);
      });

      base.addEventListener("pointermove", (e) => {
        if (!joystickActive) return;
        updateJoystick(e, base, handle);
      });

      function end(e) {
        if (!joystickActive) return;
        joystickActive = false;
        base.releasePointerCapture(e.pointerId);
        hardStopJoystick();
      }

      base.addEventListener("pointerup", end);
      base.addEventListener("pointercancel", end);
      base.addEventListener("pointerleave", (e) => {
        if (!joystickActive) return;
        hardStopJoystick();
      });
    }

    function updateJoystick(e, base, handle) {
      const rect = base.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      let dx = e.clientX - cx;
      let dy = e.clientY - cy;

      const radius = rect.width / 2;
      const dist = Math.sqrt(dx * dx + dy * dy) || 1;
      const maxDist = radius;
      if (dist > maxDist) {
        const scale = maxDist / dist;
        dx *= scale;
        dy *= scale;
      }

      const nx = dx / maxDist;  // -1..1
      const ny = dy / maxDist;  // -1..1

      // move handle
      handle.style.left = 50 + nx * 50 + "%";
      handle.style.top = 50 + ny * 50 + "%";

      const mag = Math.sqrt(nx * nx + ny * ny);
      if (mag < JOY_DEADZONE) {
        document.getElementById("left").value = "0.0";
        document.getElementById("right").value = "0.0";
        sendOpenloop(0, 0);
        return;
      }

      const speedGain = parseFloat(document.getElementById("joy-speed").value || "0.5");
      const steerGain = parseFloat(document.getElementById("joy-steer").value || "1");

      // sign conventions:
      // ny < 0 = up (forward), ny > 0 = down (back / spin zone)
      // nx < 0 = left, nx > 0 = right
      const forwardRaw = -ny;        // up = positive
      let forward = forwardRaw * speedGain;
      forward = Math.max(0, Math.min(1, forward));

      const steerRaw = -nx;          // left = positive, right = negative
      let steer = steerRaw * steerGain;
      steer = Math.max(-1, Math.min(1, steer));

      let left = 0;
      let right = 0;

      const inBackHalf = ny >= 0.05;

      if (inBackHalf) {
        // ---- Bottom half: pure spin mode ----
        if (Math.abs(steerRaw) < 0.1) {
          // near center horizontally -> no motion
          left = 0;
          right = 0;
        } else {
          const baseTurn = 0.4 + 0.6 * Math.min(1, Math.abs(steerRaw));
          if (steer > 0) {
            // joystick left => car rotates left (right wheel moves)
            left = 0.0;
            right = baseTurn;
          } else {
            // joystick right => car rotates right (left wheel moves)
            left = baseTurn;
            right = 0.0;
          }
        }
      } else {
        // ---- Top half: normal forward differential drive ----
        left = forward * (1 - steer);
        right = forward * (1 + steer);
        const maxV = Math.max(left, right, 1e-6);
        if (maxV > 1) {
          left /= maxV;
          right /= maxV;
        }
      }

      // small output deadzone
      if (Math.abs(left) < 0.02) left = 0;
      if (Math.abs(right) < 0.02) right = 0;

      // clamp to [0,1] since motors are forward-only
      left = Math.max(0, Math.min(1, left));
      right = Math.max(0, Math.min(1, right));

      document.getElementById("left").value = left.toFixed(2);
      document.getElementById("right").value = right.toFixed(2);

      sendOpenloop(left, right);
    }

    // [H] Train
    async function refreshTrainDatasets() {
      const res = await fetch("/api/datasets");
      const data = await res.json();
      if (!data.ok) return;
      const sel = document.getElementById("train-dataset");
      sel.innerHTML = "";
      (data.data.datasets || []).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        if (name === data.data.current) opt.selected = true;
        sel.appendChild(opt);
      });
      const current = data.data.current;
      if (current) {
        const summaryRes = await fetch("/api/datasets/summary?name=" + encodeURIComponent(current));
        const summaryData = await summaryRes.json();
        if (summaryData.ok) {
          document.getElementById("train-dataset-summary").textContent =
            JSON.stringify(summaryData.data, null, 2);
        }
      }
    }

    async function startTrain() {
      const dataset = document.getElementById("train-dataset").value;
      const epochs = parseInt(document.getElementById("train-epochs").value || "10", 10);
      const lr = document.getElementById("train-lr").value || "0.001";
      const batch = parseInt(document.getElementById("train-batch").value || "32", 10);
      const res = await fetch("/api/train/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dataset, epochs, lr, batch_size: batch })
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Train error: " + data.error);
        return;
      }
      document.getElementById("train-status").textContent = "Training started...\n";
      pollTrainStatus();
    }

    async function pollTrainStatus() {
      const res = await fetch("/api/train/status");
      const data = await res.json();
      if (!data.ok) return;
      const s = data.data;
      const txt = [
        "running: " + s.running,
        "epoch: " + s.epoch + " / " + s.epochs,
        "loss: " + (s.loss == null ? "None" : s.loss.toFixed(4)),
        "note: " + (s.note || "")
      ].join("\n");
      document.getElementById("train-status").textContent = txt;
      if (s.running) {
        setTimeout(pollTrainStatus, 500);
      }
    }


    async function validateDataset() {
      const sel = document.getElementById("train-dataset");
      const dataset = sel && sel.value ? sel.value : "";
      const statusPill = document.getElementById("train-test-status");
      const out = document.getElementById("train-validation");
      if (statusPill) {
        statusPill.innerHTML = '<span class="pill-dot"></span> validating...';
      }
      try {
        const url = "/api/train/validate" +
          (dataset ? ("?dataset=" + encodeURIComponent(dataset)) : "");
        const res = await fetch(url);
        const data = await res.json();
        if (!data.ok) {
          out.textContent = "Error: " + data.error;
          if (statusPill) {
            statusPill.innerHTML =
              '<span class="pill-dot pill-bad"></span> validate error';
          }
          return;
        }
        out.textContent = JSON.stringify(data.data, null, 2);
        if (statusPill) {
          statusPill.innerHTML =
            '<span class="pill-dot pill-ok"></span> validated';
        }
      } catch (e) {
        out.textContent = "Exception: " + e;
        if (statusPill) {
          statusPill.innerHTML =
            '<span class="pill-dot pill-bad"></span> validate error';
        }
      }
    }

    let ghostTimer = null;

    async function ghostStep() {
      try {
        let url = "/api/deploy/test_frame";
        const modelSel = document.getElementById("deploy-model");
        if (modelSel && modelSel.value) {
          url += "?model=" + encodeURIComponent(modelSel.value);
        }

        const res = await fetch(url);
        const data = await res.json();
        if (!data.ok) return;
        const d = data.data || {};
        if (typeof d.click_X !== "number" || typeof d.click_Y !== "number") return;

        const img = document.getElementById("video");
        const marker = document.getElementById("click-marker");
        if (!img || !marker || img.getBoundingClientRect().width <= 0) return;

        const sx = d.click_X / 149.0;
        const sy = d.click_Y / 149.0;
        const px = sx * 100;
        const py = sy * 100;

        marker.style.left = px + "%";
        marker.style.top = py + "%";
        marker.style.display = "block";
      } catch (e) {
        // overlay is best-effort only
        console.error("ghostStep error", e);
      }
    }

    function toggleGhostOverlay(on) {
      const marker = document.getElementById("click-marker");
      if (!on) {
        if (ghostTimer) {
          clearInterval(ghostTimer);
          ghostTimer = null;
        }
        if (marker) {
          marker.style.display = "none";
        }
        return;
      }
      // turn on: draw once then poll
      ghostStep();
      ghostTimer = setInterval(ghostStep, 200);
    }


    async function testModelOnCurrentFrame() {
      const trainPill = document.getElementById("train-test-status");
      const deployPill = document.getElementById("deploy-test-status");
      const out = document.getElementById("train-test-output");

      function setPill(html) {
        if (trainPill) trainPill.innerHTML = html;
        if (deployPill) deployPill.innerHTML = html;
      }

      setPill('<span class="pill-dot"></span> testing.');

      try {
        // Build URL with ?model=... if a model is selected in Deploy tab
        let url = "/api/deploy/test_frame";
        const modelSel = document.getElementById("deploy-model");
        if (modelSel && modelSel.value) {
          url += "?model=" + encodeURIComponent(modelSel.value);
        }

        const res = await fetch(url);

        // Check if response is HTML (Server Error / 404)
        const contentType = res.headers.get("content-type");
        if (contentType && contentType.includes("text/html")) {
          const text = await res.text();
          console.error("Server returned HTML instead of JSON:", text);
          out.textContent = "Error: Server returned HTML (check console). Likely 404/500.";
          setPill('<span class="pill-dot pill-bad"></span> HTML error');
          return;
        }

        const data = await res.json();
        if (!data.ok) {
          out.textContent = "Error: " + data.error;
          setPill('<span class="pill-dot pill-bad"></span> test error');
          return;
        }

        const d = data.data || {};
        out.textContent = JSON.stringify(d, null, 2);
        setPill('<span class="pill-dot pill-ok"></span> tested');

        // Overlay predicted point...
        if (typeof d.click_X === "number" &&
          typeof d.click_Y === "number" &&
          typeof d.image_width === "number" &&
          typeof d.image_height === "number") {

          const img = document.getElementById("video");
          const marker = document.getElementById("click-marker");
          if (img && marker && img.getBoundingClientRect().width > 0) {
            const sx = d.click_X / 149.0;
            const sy = d.click_Y / 149.0;
            const px = sx * 100;
            const py = sy * 100;
            marker.style.left = px + "%";
            marker.style.top = py + "%";
            marker.style.display = "block";
          }
        }
      } catch (e) {
        out.textContent = "Exception: " + e;
        setPill('<span class="pill-dot pill-bad"></span> test error');
      }
    }


    async function refreshModels() {
      try {
        const res = await fetch("/api/models");
        const data = await res.json();
        if (!data.ok) {
          alert("Model list error: " + data.error);
          return;
        }
        const sel = document.getElementById("deploy-model");
        if (!sel) return;
        sel.innerHTML = "";
        const items = data.data.items || [];
        for (const m of items) {
          const opt = document.createElement("option");
          opt.value = m.name;
          opt.textContent = m.name + " (" + m.kind + ", " + m.size_kb + " KB)";
          sel.appendChild(opt);
        }
        // status pill
        const pill = document.getElementById("model-status");
        if (pill) {
          if (items.length) {
            pill.innerHTML =
              '<span class="pill-dot pill-ok"></span> ' + items.length + ' model(s) found';
          } else {
            pill.innerHTML =
              '<span class="pill-dot"></span> no models yet';
          }
        }
      } catch (e) {
        alert("Model list exception: " + e);
      }
    }

    async function convertSelectedModelToInt8() {
      const sel = document.getElementById("deploy-model");
      if (!sel || !sel.value) {
        alert("Select a model first.");
        return;
      }

      const source = sel.value;
      if (!confirm("Create INT8 copy of: " + source + " ?")) {
        return;
      }

      try {
        const res = await fetch("/api/models/convert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ source, dtype: "int8" })
        });
        const data = await res.json();
        if (!data.ok) {
          alert("Convert error: " + data.error);
          return;
        }
        const d = data.data || {};
        alert("Created: " + d.output + " (from " + d.source + ")");
        // Refresh list so new *_int8.pt appears and gets picked up with kind="int8"
        refreshModels();
      } catch (e) {
        alert("Convert exception: " + e);
      }
    }


    // [I] Deploy
    async function pollDeployStatus() {
      const res = await fetch("/api/deploy/status");
      const data = await res.json();
      if (!data.ok) return;

      const s = data.data;
      document.getElementById("deploy-status").textContent =
        JSON.stringify(s, null, 2);

      // reflect active model
      const modelSel = document.getElementById("deploy-model");
      const modelStatus = document.getElementById("model-status");
      if (modelStatus) {
        const m = s.model || "(none)";
        modelStatus.innerHTML =
          '<span class="pill-dot pill-ok"></span> current model: ' + m;
      }
      if (modelSel && s.model) {
        for (const opt of modelSel.options) {
          if (opt.value === s.model) {
            opt.selected = true;
            break;
          }
        }
      }

      const g = s.gains || {};
      document.getElementById("deploy-throttle").value = g.throttle_gain ?? 1.0;
      document.getElementById("deploy-steering").value = g.steering_gain ?? 1.0;
      document.getElementById("deploy-expo").value = g.expo ?? 1.0;
      document.getElementById("deploy-drive").checked = !!s.drive_motors;

      // new: mode, assist, reflex, brightness
      const modeSel = document.getElementById("deploy-mode");
      if (modeSel && s.mode) {
        modeSel.value = s.mode;
      }

      const assistSlider = document.getElementById("deploy-assist");
      const assistLabel = document.getElementById("deploy-assist-label");
      if (assistSlider && typeof s.assist_blend === "number") {
        assistSlider.value = s.assist_blend.toFixed(2);
        if (assistLabel) {
          assistLabel.textContent = s.assist_blend.toFixed(2);
        }
      }

      const reflexCheckbox = document.getElementById("deploy-reflex");
      if (reflexCheckbox && typeof s.reflex_on !== "undefined") {
        reflexCheckbox.checked = !!s.reflex_on;
      }

      const minBrightInput = document.getElementById("deploy-min-brightness");
      if (minBrightInput && typeof s.min_brightness === "number") {
        minBrightInput.value = s.min_brightness.toFixed(1);
      }
    }

    async function startAutopilot() {
      const modelSel = document.getElementById("deploy-model");
      const body = {};
      if (modelSel && modelSel.value) {
        body.model = modelSel.value;
      }

      const res = await fetch("/api/deploy/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Autopilot error: " + data.error);
        return;
      }
      pollDeployStatus();
    }

    async function stopAutopilot() {
      const res = await fetch("/api/deploy/stop", { method: "POST" });
      const data = await res.json();
      if (!data.ok) {
        alert("Autopilot stop error: " + data.error);
        return;
      }
      pollDeployStatus();
    }

    async function updateDeployGains() {
      const throttle_gain = parseFloat(document.getElementById("deploy-throttle").value || "1");
      const steering_gain = parseFloat(document.getElementById("deploy-steering").value || "1");
      const expo = parseFloat(document.getElementById("deploy-expo").value || "1");
      const drive_motors = document.getElementById("deploy-drive").checked;

      const modeEl = document.getElementById("deploy-mode");
      const assistEl = document.getElementById("deploy-assist");
      const reflexEl = document.getElementById("deploy-reflex");
      const minBrightEl = document.getElementById("deploy-min-brightness");

      const body = { throttle_gain, steering_gain, expo, drive_motors };

      if (modeEl) body.mode = modeEl.value;
      if (assistEl) body.assist_blend = parseFloat(assistEl.value || "0.7");
      if (reflexEl) body.reflex_on = reflexEl.checked;
      if (minBrightEl) body.min_brightness = parseFloat(minBrightEl.value || "18");

      const res = await fetch("/api/deploy/gains", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.ok) {
        alert("Deploy gains error: " + data.error);
        return;
      }
      pollDeployStatus();
    }


    // [J] Bootstrap
    async function bootstrap() {
      fsSetPath(".");
      fsList();
      pollHealth();
      loadCameraConfig();
      refreshDatasets();
      refreshTrainDatasets();
      loadControlParams();
      setupJoystick();
      pollDeployStatus();
      refreshModels();  // <-- important
    }

    bootstrap();
  </script>
</body>

</html>